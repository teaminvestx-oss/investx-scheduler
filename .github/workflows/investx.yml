name: InvestX Telegram Scheduler

on:
  schedule:
    # 09:00 Madrid
    - cron: "0 7 * * 1-5"     # CEST 09:00 (verano)
    - cron: "0 8 * * 1-5"     # CET  09:00 (invierno)
    # 10:30 Madrid
    - cron: "30 8 * * 1-5"    # CEST 10:30 (verano)
    - cron: "30 9 * * 1-5"    # CET  10:30 (invierno)
    # 22:00 Madrid
    - cron: "0 20 * * 1-5"    # CEST 22:00 (verano)
    - cron: "0 21 * * 1-5"    # CET  22:00 (invierno)
  workflow_dispatch:

concurrency:
  group: investx-telegram-scheduler
  cancel-in-progress: false

jobs:
  send:
    runs-on: ubuntu-latest
    env:
      BOT_TOKEN: ${{ secrets.INVESTX_TOKEN }}
      CHAT_ID:   ${{ secrets.CHAT_ID }}
      MESSAGE_MODE: ${{ vars.MESSAGE_MODE }}   # "fixed" (por defecto) o "mix"
    steps:
      - name: DiagnÃ³stico
        run: |
          echo "event_name=${{ github.event_name }}"
          echo "event.schedule=${{ github.event.schedule }}"
          echo "now_utc=$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "now_madrid=$(TZ=Europe/Madrid date +'%Y-%m-%d %H:%M:%S %Z')"
          echo "MESSAGE_MODE=${MESSAGE_MODE:-fixed}"

      - name: Enviar mensaje (rotaciÃ³n 10 variantes o mix) L-V
        if: ${{ env.BOT_TOKEN != '' && env.CHAT_ID != '' }}
        env:
          TZ: Europe/Madrid
        run: |
          set -euo pipefail

          # --- Fecha/hora Madrid ---
          DOW="$(date +%u)"                 # 1=L ... 7=D
          HHMM="$(date +'%H:%M')"
          DOY="$(date +%j)"                 # 001..366
          IDX=$(( (10#${DOY} - 1) % 10 ))   # 0..9 determinista por dÃ­a del aÃ±o
          MODE="${MESSAGE_MODE:-fixed}"

          # --- Horario laborable ---
          if [ "$DOW" -gt 5 ]; then
            echo "Fin de semana en Madrid; no se envÃ­a."
            exit 0
          fi

          # --- FunciÃ³n Telegram ---
          send() {
            local text="$1"
            curl -sS "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -d chat_id="${CHAT_ID}" \
              -d parse_mode="HTML" \
              --data-urlencode text="${text}" >/dev/null
          }

          # =========================
          # VARIANTES FIJAS (10)
          # =========================

          # 09:00 â€” Buenos dÃ­as (10)
          MORNING_VARS=(
            "ğŸŒ <b>Â¡Buenos dÃ­as, equipo!</b>\n\nArrancamos en <b>InvestX</b> con setups claros, niveles clave y disciplina. Que hable la ejecuciÃ³n. ğŸš€"
            "â˜• <b>A por el dÃ­a</b>\n\nListas preparadas: soportes, resistencias y catalizadores. Menos ruido, mÃ¡s seÃ±ales. ğŸ’¥"
            "ğŸŒ… <b>Buenos dÃ­as</b>\n\nContexto + confirmaciÃ³n: momentum, volumen institucional y zonas de liquidez. ğŸ”"
            "ğŸš€ <b>Comienza la sesiÃ³n</b>\n\nMapa listo: sesgo, escenarios y gestiÃ³n del riesgo. Entrada justificada, salida planificada. ğŸ§­"
            "ğŸ”” <b>Apertura ON</b>\n\nTendencia mayor, zonas de valor y volatilidad esperada. Calidad por encima de cantidad. âœ…"
            "ğŸ“ˆ <b>Morning brief</b>\n\nRevisa watchlist, alinea marcos temporales y protege el capital. Hoy sumamos consistencia. ğŸ§±"
            "ğŸ’¡ <b>Enfoque</b>\n\nPrimero contexto, luego seÃ±al. Evita perseguir; espera que el precio venga a tu zona. ğŸª¤"
            "ğŸ§­ <b>Plan primero</b>\n\nSesgo definido, invalidaciÃ³n clara y RR mÃ­nimo. Sin plan no hay trade. ğŸ“œ"
            "ğŸ”¥ <b>Impulso inicial</b>\n\nBusca confluencias: nivel + flujo + timing. Donde coinciden, suele haber oportunidad. ğŸ¯"
            "ğŸ§  <b>Mentalidad pro</b>\n\nObserva antes de reaccionar. La paciencia filtra operaciones mediocres. â³"
          )

          # 10:30 â€” TIP del dÃ­a (10)
          TIP_VARS=(
            "ğŸ“Œ <b>TIP</b>\n\nPulsa el <b>#ticker</b> para ver todas las menciones y tener contexto al instante. ğŸ”"
            "ğŸ§  <b>TIP</b>\n\nDefine activaciÃ³n, invalidaciÃ³n y TP <b>antes</b> de abrir. Evita improvisar. ğŸ“"
            "âš™ï¸ <b>TIP</b>\n\nRuptura sin volumen = paciencia. Espera el <i>retest</i> a zona. â³"
            "ğŸ” <b>TIP</b>\n\nUnifica marcos: diario y 15m contando la misma historia aumenta la probabilidad. ğŸ¯"
            "ğŸ§­ <b>TIP</b>\n\nMarca catalizadores (earnings, macro) y evita operar contra ellos. ğŸ“…"
            "ğŸ“Š <b>TIP</b>\n\nSi el plan depende de â€œque pase algoâ€, no es plan: reescribe el setup. âœï¸"
            "ğŸ›¡ï¸ <b>TIP</b>\n\nStop lÃ³gico detrÃ¡s de nivel defendido, no arbitrario por distancia. ğŸ›‘"
            "ğŸ”„ <b>TIP</b>\n\nSi falla el primer escenario, ten listo el alternativo con sesgo contrario. â™»ï¸"
            "ğŸ“ <b>TIP</b>\n\nNo sacrifiques RR por entrar â€œyaâ€. El precio da segundas oportunidades. ğŸ£"
            "ğŸ›ï¸ <b>TIP</b>\n\nReduce tamaÃ±o si sube la volatilidad; preserva la curva de capital. ğŸ“‰â¡ï¸ğŸ“ˆ"
          )

          # 22:00 â€” Cierre (10)
          CLOSE_VARS=(
            "ğŸŒ™ <b>Cierre de mercado</b>\n\nAnota quÃ© funcionÃ³ y quÃ© no. La consistencia vive en el post-anÃ¡lisis. ğŸ“"
            "âœ… <b>Diario</b>\n\nCaptura pantallas y lecciones. MaÃ±ana decides mejor con evidencia. ğŸ“š"
            "ğŸ§© <b>Resumen</b>\n\nRepasa setups activos, defensas institucionales y gaps pendientes. ğŸ”„"
            "ğŸ““ <b>Checklist</b>\n\nActualiza niveles â†’ clasifica activos A/B â†’ define sesgo para maÃ±ana. ğŸ˜´"
            "ğŸ”„ <b>Plan</b>\n\nMantÃ©n lo que aporta, elimina lo accesorio. La fuerza estÃ¡ en la simplicidad. ğŸ’¡"
            "ğŸ§  <b>Higiene mental</b>\n\nCierra plataformas y deja escrito el primer trade si se da la seÃ±al. ğŸ§˜"
            "ğŸ§± <b>Base sÃ³lida</b>\n\nRR real, no ideal. Ajusta objetivos a la estructura. ğŸ§®"
            "ğŸ›°ï¸ <b>Vista macro</b>\n\nÂ¿CambiÃ³ el contexto? Alinea el sesgo con el marco temporal mayor. ğŸŒ"
            "ğŸ“Œ <b>Anclajes</b>\n\nSeÃ±ala niveles que el precio respetÃ³ hoy: suelen importar maÃ±ana. ğŸ“"
            "ğŸ—ºï¸ <b>Ruta</b>\n\nEscenario 1 si continÃºa impulso, 2 si corrige a valor. Llega con mapa, no a ciegas. ğŸ—ºï¸"
          )

          # =========================
          # MODO MIX (tipo IA sin APIs)
          # =========================
          OPENINGS_M=( "ğŸŒ <b>Â¡Buenos dÃ­as, equipo!</b>" "â˜• <b>A por el dÃ­a</b>" "ğŸŒ… <b>Buenos dÃ­as</b>" "ğŸš€ <b>Comienza la sesiÃ³n</b>" "ğŸ”” <b>Apertura ON</b>" )
          BODIES_M=( "Arrancamos en <b>InvestX</b> con setups de calidad y gestiÃ³n del riesgo." "Mapeamos niveles, catalizadores y sesgo antes de tocar el botÃ³n." "Contexto + confirmaciÃ³n: que el precio venga a nuestra zona." "Primero plan, luego trade: activaciÃ³n e invalidaciÃ³n claras." "Menos ruido, mÃ¡s seÃ±ales: volumen y zonas de valor mandan." )
          CLOSERS_M=( "Que hable la ejecuciÃ³n. ğŸš€" "Hoy sumamos consistencia. ğŸ§±" "Paciencia = ventaja. â³" "Entrada justificada, salida planificada. ğŸ§­" "Calidad > cantidad. âœ…" )

          OPENINGS_T=( "ğŸ“Œ <b>TIP</b>" "ğŸ§  <b>TIP</b>" "ğŸ” <b>TIP</b>" "âš™ï¸ <b>TIP</b>" "ğŸ§­ <b>TIP</b>" )
          BODIES_T=( "Pulsa el <b>#ticker</b> para contexto al instante." "Escribe activaciÃ³n, invalidaciÃ³n y TP antes de entrar." "Ruptura sin volumen â†’ espera el retest." "Alinea diario y 15m para reforzar probabilidad." "Evita operar contra catalizadores del dÃ­a." )
          CLOSERS_T=( "Decidir con datos gana. ğŸ”" "Menos impulsividad, mÃ¡s plan. ğŸ“" "La paciencia paga. â³" "Confluencia > ocurrencias. ğŸ¯" "Controla el riesgo, no el mercado. ğŸ›¡ï¸" )

          OPENINGS_C=( "ğŸŒ™ <b>Cierre de mercado</b>" "âœ… <b>Diario</b>" "ğŸ§© <b>Resumen</b>" "ğŸ““ <b>Checklist</b>" "ğŸ”„ <b>Plan</b>" )
          BODIES_C=( "Anota lo que funcionÃ³ y lo que no; ahÃ­ vive la mejora." "Actualiza niveles y clasifica activos para maÃ±ana." "Revisa gaps y defensas institucionales que dejÃ³ el dÃ­a." "Alinea el sesgo con el marco mayor si cambiÃ³ el contexto." "Deja escrito el primer trade si se da la seÃ±al." )
          CLOSERS_C=( "La consistencia estÃ¡ en el post-anÃ¡lisis. ğŸ“" "Dormir con el plan hecho = ventaja. ğŸ˜´" "Simplicidad gana. ğŸ’¡" "RR real, no ideal. ğŸ§®" "MaÃ±ana se ejecuta mejor. ğŸ“š" )

          pick_from_bank() {
            # $1 nombre del array, $2 semilla
            local name="$1"; local seed="$2"
            local -n ARR="$name"
            local n="${#ARR[@]}"
            local idx=$(( seed % n ))
            echo "${ARR[$idx]}"
          }

          build_mix() {
            local slot="$1"
            local seed=$((10#${DOY} + $(echo "$HHMM" | tr -d ':') ))
            case "$slot" in
              morning)
                echo -e "$(pick_from_bank OPENINGS_M $seed)\n$(pick_from_bank BODIES_M $((seed+1))) $(pick_from_bank CLOSERS_M $((seed+2)))"
              ;;
              tip)
                echo -e "$(pick_from_bank OPENINGS_T $seed)\n$(pick_from_bank BODIES_T $((seed+1))) $(pick_from_bank CLOSERS_T $((seed+2)))"
              ;;
              close)
                echo -e "$(pick_from_bank OPENINGS_C $seed)\n$(pick_from_bank BODIES_C $((seed+1))) $(pick_from_bank CLOSERS_C $((seed+2)))"
              ;;
            esac
          }

          # --- Selector por hora ---
          case "$HHMM" in
            "09:00")
              if [ "$MODE" = "mix" ]; then TEXTO="$(build_mix morning)"; else TEXTO="${MORNING_VARS[$IDX]}"; fi
              ;;
            "10:30")
              if [ "$MODE" = "mix" ]; then TEXTO="$(build_mix tip)"; else TEXTO="${TIP_VARS[$IDX]}"; fi
              ;;
            "22:00")
              if [ "$MODE" = "mix" ]; then TEXTO="$(build_mix close)"; else TEXTO="${CLOSE_VARS[$IDX]}"; fi
              ;;
            *)
              echo "No hay mensaje definido para ${HHMM}; no se envÃ­a."
              exit 0
              ;;
          esac

          echo "Modo=${MODE} | DÃ­a=${DOY} | Variante=${IDX} | Enviando ${HHMM} Madridâ€¦"
          send "${TEXTO}"
