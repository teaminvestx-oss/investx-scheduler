name: InvestX Telegram Scheduler

on:
  schedule:
    # 09:00 Madrid
    - cron: "0 7 * * 1-5"     # CEST 09:00 (verano)
    - cron: "0 8 * * 1-5"     # CET  09:00 (invierno)
    # 10:30 Madrid
    - cron: "30 8 * * 1-5"    # CEST 10:30 (verano)
    - cron: "30 9 * * 1-5"    # CET  10:30 (invierno)
    # 22:00 Madrid
    - cron: "0 20 * * 1-5"    # CEST 22:00 (verano)
    - cron: "0 21 * * 1-5"    # CET  22:00 (invierno)
  workflow_dispatch:
    inputs:
      slot:
        description: "Forzar franja: morning | tip | close | auto"
        required: false
        default: "auto"

concurrency:
  group: investx-telegram-scheduler
  cancel-in-progress: false

jobs:
  send:
    runs-on: ubuntu-latest
    env:
      BOT_TOKEN: ${{ secrets.INVESTX_TOKEN }}
      CHAT_ID:   ${{ secrets.CHAT_ID }}
    steps:
      - name: Enviar mensaje (rotaciÃ³n temÃ¡tica)
        env:
          TZ: Europe/Madrid
        run: |
          set -euo pipefail

          # --------- Fecha/hora ---------
          DOW="$(date +%u)"          # 1=L ... 7=D
          HHMM_NOW="$(date +'%H:%M')"
          DOY="$(date +%j)"          # 001..366
          SLOT="${{ github.event.inputs.slot || 'auto' }}"

          # --------- Fin de semana ---------
          if [ "$DOW" -gt 5 ] && [ "$SLOT" = "auto" ]; then
            echo "Fin de semana: no se envÃ­a."
            exit 0
          fi

          # --------- Telegram helper ---------
          send() {
            local text="$1"
            curl -sS "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -d chat_id="${CHAT_ID}" -d parse_mode="HTML" \
              --data-urlencode text="${text}" >/dev/null
          }

          # =========================
          # VARIANTES TEMÃTICAS
          # =========================

          # 09:00 â€” Buenos dÃ­as (10)
          MORNING_VARS=(
            $'ğŸŒ <b>Â¡Buenos dÃ­as, equipo!</b>\n\nArrancamos la sesiÃ³n con el mapa listo: soportes, resistencias y catalizadores marcados. Hoy el foco estÃ¡ en <b>ejecutar limpio</b>.'
            $'â˜• <b>Buenos dÃ­as, InvestX.</b>\n\nEmpieza la jornada con setups claros y un recordatorio: <b>paciencia > impulsividad</b>. Espera que el precio venga a ti.'
            $'ğŸŒ… <b>Buenos dÃ­as.</b>\n\nJornada nueva, mismas reglas: contexto, confluencia y plan. El institucional ya ha dejado sus huellas, toca seguirlas.'
            $'ğŸš€ <b>Arrancamos el dÃ­a.</b>\n\nRevisa tu lista A/B, define sesgo y RR mÃ­nimo. La consistencia empieza en el checklist de la maÃ±ana.'
            $'ğŸ”” <b>Buenos dÃ­as, traders.</b>\n\nHoy mandan las estructuras de valor: detecta las zonas donde el volumen se concentra y filtra el ruido.'
            $'ğŸ“ˆ <b>InvestX en marcha.</b>\n\nPrepÃ¡rate: momentum, liquidez y catalizadores. Menos operaciones, mÃ¡s calidad.'
            $'ğŸ’¡ <b>Buenos dÃ­as.</b>\n\nHoy toca recordar que la ventaja estÃ¡ en la <b>planificaciÃ³n previa</b>: niveles y escenarios definidos antes de abrir el mercado.'
            $'ğŸ§­ <b>Arranque de jornada.</b>\n\nEntrada justificada, salida planificada. Esa es la fÃ³rmula. Sin plan, no hay trade.'
            $'ğŸ” <b>Buenos dÃ­as.</b>\n\nEmpieza con visiÃ³n macro y baja a micro: cuando ambos marcos cuentan la misma historia, la probabilidad se multiplica.'
            $'ğŸ§  <b>Buenos dÃ­as, equipo.</b>\n\nObserva primero, reacciona despuÃ©s. El mercado recompensa la paciencia y castiga la prisa.'
          )

          # 10:30 â€” Tip del canal (#ticker) (10)
          TIP_VARS=(
            $'ğŸ“Œ <b>TIP del canal.</b>\n\nPulsa un <b>#ticker</b> y verÃ¡s todas las menciones, informes y setups de ese activo. Contexto al instante, mejor decisiÃ³n.'
            $'ğŸ§  <b>TIP del canal.</b>\n\nAntes de entrar en una operaciÃ³n, revisa el <b>#ticker</b>. Â¿Catalizadores hoy? Â¿QuÃ© opinaba el canal ayer? Te ahorra errores.'
            $'ğŸ” <b>TIP del canal.</b>\n\nEl <b>#ticker</b> agrupa ideas, resÃºmenes y alertas de cada activo. Ãšsalo como repaso rÃ¡pido antes de abrir posiciÃ³n.'
            $'âš™ï¸ <b>TIP del canal.</b>\n\nCrea rutina: seÃ±al â†’ revisa el <b>#ticker</b> â†’ valida contexto. AsÃ­ filtras operaciones dÃ©biles.'
            $'ğŸ§­ <b>TIP del canal.</b>\n\nSi un activo estÃ¡ en tu lista A/B, pÃ¡sate por su <b>#ticker</b>: verÃ¡s niveles defendidos y setups vivos.'
            $'ğŸ“ <b>TIP del canal.</b>\n\nGuarda mensajes clave y luego accede con <b>#ticker</b>. Mantienes coherencia en tu plan.'
            $'ğŸ“š <b>TIP del canal.</b>\n\nCada <b>#ticker</b> es un mini-historial del activo: zonas, noticias y anÃ¡lisis. No lo ignores antes de tomar decisiÃ³n.'
            $'ğŸ§© <b>TIP del canal.</b>\n\nCon el <b>#ticker</b> reduces ruido: toda la info en un clic. Contexto es ventaja.'
            $'ğŸ›°ï¸ <b>TIP del canal.</b>\n\nUsa el <b>#ticker</b> para unir visiÃ³n macro y micro del mismo valor. Panorama completo en segundos.'
            $'ğŸ—‚ï¸ <b>TIP del canal.</b>\n\nTu flujo deberÃ­a ser: idea â†’ <b>#ticker</b> â†’ validar â†’ ejecutar. Proceso repetible = consistencia.'
          )

          # 22:00 â€” Cierre de mercado (15, tono analista)
          CLOSE_VARS=(
            $'ğŸŒ™ <b>Cierre de mercado</b>\n\nTipo de dÃ­a: <i>tendencial</i>. Los tirones respetaron VWAP y dejaron <b>mÃ­nimos crecientes</b>.\nMapa para maÃ±ana: mantener sesgo mientras no se pierdan los <b>niveles de valor</b> marcados.'
            $'ğŸ§© <b>Cierre de mercado</b>\n\nSesiÃ³n <i>equilibrada</i>: rotaciÃ³n por rangos y defensa clara del <b>PDC</b>.\nPlan: esperar ruptura con volumen o <i>retest</i> a borde del balance para buscar continuidad.'
            $'ğŸ““ <b>Cierre de mercado</b>\n\nAnota <b>MAE/MFE</b> de tus entradas y si el <b>RR</b> fue real o ideal.\nAjusta objetivos a la estructura que dejÃ³ hoy el precio; maÃ±ana no fuerces extensiones.'
            $'ğŸ”„ <b>Cierre de mercado</b>\n\nQuedaron <b>gaps</b> abiertos y zonas de liquidez barridas en la apertura.\nEscenario 1: barrido y continuaciÃ³n; Escenario 2: relleno de gap hacia valor. Ten ambos escritos.'
            $'ğŸ§  <b>Cierre de mercado</b>\n\nÂ¿QuÃ© <b>confluencias</b> funcionaron? (nivel + flujo + timing).\nDuplica lo que aportÃ³ y elimina lo accesorio. Consistencia > brillantez puntual.'
            $'ğŸ“ <b>Cierre de mercado</b>\n\nNiveles que el precio <b>respetÃ³</b> hoy: (1) semanal, (2) diaria, (3) intradÃ­a.\nEtiquÃ©talos en tu watchlist; suelen ser los que importan en la apertura.'
            $'ğŸ›°ï¸ <b>Cierre de mercado</b>\n\nMacro sin sorpresas, tÃ©cnica mandando. Revisa si el marco <b>diario</b> confirma lo visto en <b>15m</b>.\nSi cuentan la misma historia, la probabilidad sube.'
            $'ğŸ§® <b>Cierre de mercado</b>\n\nRecalcula tamaÃ±o por <b>volatilidad</b>: rango de hoy vs. media 10 sesiones.\nSi el rango se expandiÃ³, reduce tamaÃ±o para mantener riesgo constante.'
            $'ğŸ§± <b>Cierre de mercado</b>\n\nDefensa institucional visible: bloque de Ã³rdenes mantuvo zona.\nMaÃ±ana, la invalidaciÃ³n va <b>detrÃ¡s</b> de ese nivel, no por distancia arbitraria.'
            $'ğŸ—ºï¸ <b>Cierre de mercado</b>\n\nClasifica A/B: A = setups con confluencia y catalizador a favor; B = ideas a vigilar.\nOpera A, observa B. Menos dispersiÃ³n, mÃ¡s edge.'
            $'âš™ï¸ <b>Cierre de mercado</b>\n\nHoy el <b>VWAP</b> actuÃ³ como bisagra. Si maÃ±ana abrimos por encima y se sostiene, sesgo alcista hasta zona de oferta; si no, vuelta a valor.'
            $'ğŸ“Š <b>Cierre de mercado</b>\n\nRevisa <b>delta/volumen</b>: las rupturas vÃ¡lidas llevaron participaciÃ³n, las falsas no.\nTu gatillo debe exigir confirmaciÃ³n, no suposiciones.'
            $'ğŸ§­ <b>Cierre de mercado</b>\n\nCatalizadores de maÃ±ana (earnings/macro): marca horas y activos afectados.\nEvita abrir justo antes; mejor operar el <i>post-evento</i> con niveles claros.'
            $'ğŸ” <b>Cierre de mercado</b>\n\nEstructura: <i>pullback a valor</i> y continuaciÃ³n.\nEscribe el primer trade condicional: precio en zona â†’ seÃ±al â†’ entrada; sin seÃ±al, no hay trade.'
            $'ğŸ’¡ <b>Cierre de mercado</b>\n\nAprendizaje del dÃ­a: Â¿dÃ³nde te adelantaste? Â¿dÃ³nde faltÃ³ paciencia?\nTu ventaja estÃ¡ en ejecutar el plan, no en adivinar el siguiente tick.'
          )

          # --------- Determinar SLOT si auto ---------
          if [ "$SLOT" = "auto" ]; then
            case "$HHMM_NOW" in
              "09:00") SLOT="morning";;
              "10:30") SLOT="tip";;
              "22:00") SLOT="close";;
              *) echo "Auto: ${HHMM_NOW} no tiene mensaje. No se envÃ­a."; exit 0;;
            esac
          fi

          # --------- SelecciÃ³n del Ã­ndice por franja (rotaciÃ³n por dÃ­a) ---------
          # CÃ¡lculo determinista por franja para evitar desbordes si tamaÃ±os difieren
          pick_idx() {
            local size="$1"; local doy="$2"
            echo $(( (10#${doy} - 1) % size ))
          }

          case "$SLOT" in
            morning)
              i="$(pick_idx ${#MORNING_VARS[@]} "$DOY")"
              TEXTO="${MORNING_VARS[$i]}"
              ;;
            tip)
              i="$(pick_idx ${#TIP_VARS[@]} "$DOY")"
              TEXTO="${TIP_VARS[$i]}"
              ;;
            close)
              i="$(pick_idx ${#CLOSE_VARS[@]} "$DOY")"
              TEXTO="${CLOSE_VARS[$i]}"
              ;;
          esac

          echo "SLOT=${SLOT} | DOY=${DOY} | VAR=${i} | HHMM_NOW=${HHMM_NOW}"
          send "${TEXTO}"
