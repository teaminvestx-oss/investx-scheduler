name: InvestX Telegram Scheduler

on:
  schedule:
    # 09:00 Madrid
    - cron: "0 7 * * 1-5"     # CEST 09:00
    - cron: "0 8 * * 1-5"     # CET  09:00
    # 10:30 Madrid
    - cron: "30 8 * * 1-5"    # CEST 10:30
    - cron: "30 9 * * 1-5"    # CET  10:30
    # 22:00 Madrid
    - cron: "0 20 * * 1-5"    # CEST 22:00
    - cron: "0 21 * * 1-5"    # CET  22:00
  workflow_dispatch:
    inputs:
      slot:
        description: "QuÃ© enviar al forzar: morning | tip | close | auto"
        required: false
        default: "auto"
      mode:
        description: "Mensaje: fixed (10 variantes) o mix (combinado)"
        required: false
        default: "fixed"

concurrency:
  group: investx-telegram-scheduler
  cancel-in-progress: false

jobs:
  send:
    runs-on: ubuntu-latest
    env:
      BOT_TOKEN: ${{ secrets.INVESTX_TOKEN }}
      CHAT_ID:   ${{ secrets.CHAT_ID }}
      MESSAGE_MODE: ${{ vars.MESSAGE_MODE }}   # "fixed" o "mix"
    steps:
      - name: DiagnÃ³stico
        run: |
          echo "event_name=${{ github.event_name }}"
          echo "event.schedule=${{ github.event.schedule }}"
          echo "now_utc=$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "now_madrid=$(TZ=Europe/Madrid date +'%Y-%m-%d %H:%M:%S %Z')"
          echo "dispatch.slot=${{ github.event.inputs.slot }}"
          echo "dispatch.mode=${{ github.event.inputs.mode }}"
          echo "MESSAGE_MODE(default)=${MESSAGE_MODE:-fixed}"

      - name: Enviar (rotaciÃ³n o mix) L-V con ancla por franja
        if: ${{ env.BOT_TOKEN != '' && env.CHAT_ID != '' }}
        env:
          TZ: Europe/Madrid
        run: |
          set -euo pipefail

          # --------- Fecha/hora y flags ---------
          DOW="$(date +%u)"                               # 1=L ... 7=D
          HHMM_NOW="$(date +'%H:%M')"
          DOY="$(date +%j)"                               # 001..366
          IDX=$(( (10#${DOY} - 1) % 10 ))                 # 0..9
          DISPATCH_SLOT="${{ github.event.inputs.slot || 'auto' }}"
          DISPATCH_MODE="${{ github.event.inputs.mode || '' }}"
          MODE="${DISPATCH_MODE:-${MESSAGE_MODE:-fixed}}"

          # --------- SLOT forzado / auto ---------
          case "$DISPATCH_SLOT" in
            morning|tip|close) SLOT="$DISPATCH_SLOT";;
            auto|"") SLOT="auto";;
            *) echo "slot invÃ¡lido: $DISPATCH_SLOT (usa morning|tip|close|auto)"; exit 1;;
          esac

          # --------- Fin de semana (solo auto) ---------
          if [ "$DOW" -gt 5 ] && [ "$SLOT" = "auto" ]; then
            echo "Fin de semana (auto): no se envÃ­a."
            exit 0
          fi

          # --------- Telegram helper ---------
          send() {
            local text="$1"
            curl -sS "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -d chat_id="${CHAT_ID}" -d parse_mode="HTML" \
              --data-urlencode text="${text}" >/dev/null
          }

          # =========================
          # VARIANTES FIJAS (10)
          # =========================
          # 09:00 â€” SIEMPRE â€œBuenos dÃ­as / InvestXâ€
          MORNING_VARS=(
            $'ğŸŒ <b>Â¡Buenos dÃ­as, equipo!</b>\n\nArrancamos en <b>InvestX</b> con setups claros, niveles clave y disciplina. Que hable la ejecuciÃ³n. ğŸš€'
            $'ğŸŒ <b>Buenos dÃ­as</b> ğŸ‘‹\n\nEn <b>InvestX</b> hoy mandan contexto y confirmaciÃ³n: volumen, momentum y zonas de liquidez. ğŸ”'
            $'â˜• <b>A por el dÃ­a</b>\n\nPrimero el plan: sesgo, activaciÃ³n e invalidaciÃ³n. Luego la entrada. <b>InvestX</b> en modo foco. ğŸ§­'
            $'ğŸŒ… <b>Buenos dÃ­as</b>\n\nTendencia mayor + zonas de valor + volatilidad esperada = calidad > cantidad. âœ…'
            $'ğŸ’¡ <b>Buenos dÃ­as</b>\n\nMapeamos soportes, resistencias y catalizadores. Menos ruido, mÃ¡s seÃ±ales. ğŸ’¥'
            $'ğŸš€ <b>Comienza la sesiÃ³n</b>\n\nRevisa tu watchlist y alinea marcos temporales. Cuidemos la curva de capital. ğŸ§±'
            $'ğŸ”” <b>Buenos dÃ­as, InvestX</b>\n\nQue el precio venga a tu zona: paciencia y ejecuciÃ³n limpia. â³'
            $'ğŸ§­ <b>Buenos dÃ­as</b>\n\nEntrada justificada, salida planificada. Sin plan no hay trade. ğŸ“œ'
            $'ğŸ“ˆ <b>Buenos dÃ­as</b>\n\nBusca confluencias (nivel + flujo + timing). Donde coinciden, hay oportunidad. ğŸ¯'
            $'ğŸ§  <b>Buenos dÃ­as</b>\n\nObserva > reacciona. Filtra operaciones mediocres con paciencia. ğŸ§˜'
          )

          # 10:30 â€” SIEMPRE incluye #ticker (nÃºcleo del tip)
          TIP_VARS=(
            $'ğŸ“Œ <b>TIP del canal</b>\n\nToca el <b>#ticker</b> en cualquier mensaje para ver <b>todas</b> las menciones, informes y noticias de ese activo.\nÃšsalo para contexto al instante. ğŸ”'
            $'ğŸ§  <b>TIP del canal</b>\n\nCon el <b>#ticker</b> accedes al histÃ³rico del valor en el canal. \nCombÃ­nalo con tu lista A/B para priorizar oportunidades. ğŸ—‚ï¸'
            $'ğŸ” <b>TIP del canal</b>\n\nEl <b>#ticker</b> te agrupa setups, resÃºmenes y alertas del activo.\nPerfecto para repasar rÃ¡pido antes de operar. â±ï¸'
            $'âš™ï¸ <b>TIP del canal</b>\n\nUsa <b>#ticker</b> + tu timeframe de ejecuciÃ³n para validar contexto â†’ seÃ±al.\nMenos impulsividad, mÃ¡s plan. ğŸ“'
            $'ğŸ§­ <b>TIP del canal</b>\n\nPulsa <b>#ticker</b> y verÃ¡s noticias, anÃ¡lisis y niveles relevantes del valor.\nDecidir con datos gana. ğŸ“Š'
            $'ğŸ“ <b>TIP del canal</b>\n\nGuarda los posts clave y vuelve a ellos desde <b>#ticker</b>.\nAsÃ­ mantienes continuidad en tu plan. ğŸ”'
            $'ğŸ“š <b>TIP del canal</b>\n\nAntes de abrir posiciÃ³n, revisa el <b>#ticker</b> del activo: \nÂ¿hay catalizadores hoy? Â¿niveles defendidos? ğŸ“…'
            $'ğŸ§© <b>TIP del canal</b>\n\nEl <b>#ticker</b> te ahorra tiempo: todo lo del valor en un toque.\nMejor contexto, mejores decisiones. ğŸ¯'
            $'ğŸ›°ï¸ <b>TIP del canal</b>\n\n#ticker para ver el panorama completo del activo en el canal.\nContexto macro + tÃ©cnico sin perderte nada. ğŸŒ'
            $'ğŸ—‚ï¸ <b>TIP del canal</b>\n\nCrea tu rutina: idea â†’ <b>#ticker</b> â†’ validar niveles â†’ ejecutar.\nProceso repetible = consistencia. âœ…'
          )

          # 22:00 â€” SIEMPRE â€œCierre de mercadoâ€
          CLOSE_VARS=(
            $'ğŸŒ™ <b>Cierre de mercado</b>\n\nAnota quÃ© funcionÃ³ y quÃ© no. La consistencia vive en el post-anÃ¡lisis.\nPrepara escenarios para maÃ±ana. ğŸ“'
            $'ğŸŒ™ <b>Cierre de mercado</b>\n\nActualiza niveles y clasifica activos A/B. \nLlegar con el mapa hecho es ventaja. ğŸ—ºï¸'
            $'ğŸŒ™ <b>Cierre de mercado</b>\n\nRepasa setups vivos, defensas institucionales y gaps.\nDefine si esperas impulso o correcciÃ³n. ğŸ”„'
            $'ğŸŒ™ <b>Cierre de mercado</b>\n\nChecklist: niveles â†’ sesgo â†’ catalizadores.\nDormir con el plan hecho = mejor ejecuciÃ³n. ğŸ˜´'
            $'ğŸŒ™ <b>Cierre de mercado</b>\n\nMantÃ©n lo que aporta y elimina lo accesorio.\nSimplicidad gana. ğŸ’¡'
            $'ğŸŒ™ <b>Cierre de mercado</b>\n\nEscribe el primer trade <i>si</i> se da la seÃ±al.\nEntrar por plan, no por impulso. ğŸ§­'
            $'ğŸŒ™ <b>Cierre de mercado</b>\n\nObjetivos con RR <b>real</b>, no ideal.\nAjusta a la estructura del precio. ğŸ§®'
            $'ğŸŒ™ <b>Cierre de mercado</b>\n\nSi cambiÃ³ el contexto, alinea el sesgo con el marco mayor.\nEvita forzar lecturas. ğŸŒ'
            $'ğŸŒ™ <b>Cierre de mercado</b>\n\nSeÃ±ala niveles respetados hoy: suelen importar maÃ±ana.\nAnticÃ­pate. ğŸ“'
            $'ğŸŒ™ <b>Cierre de mercado</b>\n\nEscenario 1 si continÃºa impulso, 2 si vuelve a valor.\nPlan A/B listo para maÃ±ana. ğŸ—‚ï¸'
          )

          # =========================
          # MODO MIX (generativo con ancla)
          # =========================
          # Bancos y ANCLA fija por slot
          M_OPEN=( $'ğŸŒ <b>Â¡Buenos dÃ­as, equipo!</b>' $'ğŸŒ <b>Buenos dÃ­as</b> ğŸ‘‹' $'â˜• <b>A por el dÃ­a</b>' $'ğŸŒ… <b>Buenos dÃ­as</b>' $'ğŸš€ <b>Comienza la sesiÃ³n</b>' )
          M_BODY=( $'En <b>InvestX</b> manda calidad: contexto + confirmaciÃ³n antes de ejecutar.' $'Mapeamos niveles, sesgo y catalizadores para filtrar ruido.' $'Que el precio venga a tu zona: paciencia y foco.' $'Entrada justificada, salida planificada: plan primero.' $'Confluencia de nivel, flujo y timing = oportunidad.' )
          M_CLOSE=( $'Que hable la ejecuciÃ³n. ğŸš€' $'Hoy sumamos consistencia. ğŸ§±' $'Calidad > cantidad. âœ…' $'Paciencia = ventaja. â³' $'Protege la curva de capital. ğŸ›¡ï¸' )

          T_ANCHOR=( $'ğŸ“Œ <b>TIP del canal</b>\n\nToca el <b>#ticker</b> en cualquier mensaje para ver todo lo relacionado con ese activo.' )
          T_BODY=( $'Ãšsalo para repasar contexto antes de operar.' $'CombÃ­nalo con tu lista A/B para priorizar.' $'Valida niveles y news rÃ¡pidamente.' $'Te ahorra tiempo y decisiones a ciegas.' $'Integra #ticker en tu rutina diaria.' )
          T_END=( $'Decidir con datos gana. ğŸ”' $'Menos impulsividad, mÃ¡s plan. ğŸ“' $'Confluencia > ocurrencias. ğŸ¯' $'Evita operar contra catalizadores. ğŸ“…' $'Proceso repetible = consistencia. âœ…' )

          C_ANCHOR=( $'ğŸŒ™ <b>Cierre de mercado</b>' )
          C_BODY=( $'Anota aprendizajes y actualiza niveles para maÃ±ana.' $'Revisa setups vivos, defensas y gaps.' $'Alinea sesgo con el marco mayor si cambiÃ³ el contexto.' $'Escribe el primer trade si se da la seÃ±al.' $'Ajusta objetivos a la estructura, RR real.' )
          C_END=( $'Llegar con el plan hecho es ventaja. ğŸ—ºï¸' $'La consistencia vive en el post-anÃ¡lisis. ğŸ“' $'Simplicidad gana. ğŸ’¡' $'Paciencia y foco. â³' $'MaÃ±ana se ejecuta mejor. ğŸ“š' )

          pick() { local -n A=$1; local seed=$2; local n=${#A[@]}; echo "${A[$((seed % n))]}"; }

          build_mix() {
            local slot="$1"
            local seed=$((10#${DOY} + $(echo "$HHMM_NOW" | tr -d ':') ))
            case "$slot" in
              morning) echo -e "$(pick M_OPEN $seed)\n$(pick M_BODY $((seed+1))) $(pick M_CLOSE $((seed+2)))";;
              tip)     echo -e "${T_ANCHOR[0]}\n$(pick T_BODY $seed) $(pick T_END $((seed+1)))";;   # SIEMPRE #ticker
              close)   echo -e "${C_ANCHOR[0]}\n$(pick C_BODY $seed) $(pick C_END $((seed+1)))";;   # SIEMPRE â€œCierre de mercadoâ€
            esac
          }

          # --------- Determinar SLOT si auto ---------
          if [ "$SLOT" = "auto" ]; then
            case "$HHMM_NOW" in
              "09:00") SLOT="morning";;
              "10:30") SLOT="tip";;
              "22:00") SLOT="close";;
              *) echo "Auto: ${HHMM_NOW} no tiene mensaje. No se envÃ­a."; exit 0;;
            esac
          fi

          # --------- ConstrucciÃ³n del mensaje ---------
          case "$SLOT" in
            morning)
              if [ "$MODE" = "mix" ]; then TEXTO="$(build_mix morning)"; else TEXTO="${MORNING_VARS[$IDX]}"; fi
              ;;
            tip)
              if [ "$MODE" = "mix" ]; then TEXTO="$(build_mix tip)"; else TEXTO="${TIP_VARS[$IDX]}"; fi
              ;;
            close)
              if [ "$MODE" = "mix" ]; then TEXTO="$(build_mix close)"; else TEXTO="${CLOSE_VARS[$IDX]}"; fi
              ;;
          esac

          echo "SLOT=${SLOT} | MODE=${MODE} | DOY=${DOY} | VAR=${IDX} | HHMM_NOW=${HHMM_NOW}"
          send "${TEXTO}"
