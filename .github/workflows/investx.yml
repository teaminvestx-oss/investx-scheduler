name: InvestX Telegram Scheduler

on:
  schedule:
    # 09:00 Madrid
    - cron: "0 7 * * 1-5"     # CEST 09:00
    - cron: "0 8 * * 1-5"     # CET  09:00
    # 10:30 Madrid
    - cron: "30 8 * * 1-5"    # CEST 10:30
    - cron: "30 9 * * 1-5"    # CET  10:30
    # 22:00 Madrid
    - cron: "0 20 * * 1-5"    # CEST 22:00
    - cron: "0 21 * * 1-5"    # CET  22:00
  workflow_dispatch:
    inputs:
      slot:
        description: "Forzar franja: morning | tip | close | auto"
        required: false
        default: "auto"

concurrency:
  group: investx-telegram-scheduler
  cancel-in-progress: false

jobs:
  send:
    runs-on: ubuntu-latest
    env:
      BOT_TOKEN: ${{ secrets.INVESTX_TOKEN }}
      CHAT_ID:   ${{ secrets.CHAT_ID }}
    steps:
      - name: Enviar mensaje (rotaciÃ³n 10 variantes)
        env:
          TZ: Europe/Madrid
        run: |
          set -euo pipefail

          # --------- Fecha/hora ---------
          DOW="$(date +%u)"          # 1=L ... 7=D
          HHMM_NOW="$(date +'%H:%M')"
          DOY="$(date +%j)"          # 001..366
          IDX=$(( (10#${DOY} - 1) % 10 ))
          SLOT="${{ github.event.inputs.slot || 'auto' }}"

          # --------- Fin de semana ---------
          if [ "$DOW" -gt 5 ] && [ "$SLOT" = "auto" ]; then
            echo "Fin de semana: no se envÃ­a."
            exit 0
          fi

          # --------- Telegram helper ---------
          send() {
            local text="$1"
            curl -sS "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -d chat_id="${CHAT_ID}" -d parse_mode="HTML" \
              --data-urlencode text="${text}" >/dev/null
          }

          # =========================
          # VARIANTES FIJAS (10 cada franja)
          # =========================

          # 09:00 â€” Buenos dÃ­as
          MORNING_VARS=(
            $'ğŸŒ <b>Â¡Buenos dÃ­as, equipo!</b>\n\nArrancamos la sesiÃ³n con el mapa listo: soportes, resistencias y catalizadores marcados. Hoy el foco estÃ¡ en <b>ejecutar limpio</b>.'
            $'â˜• <b>Buenos dÃ­as, InvestX.</b>\n\nEmpieza la jornada con setups claros y un recordatorio: <b>paciencia > impulsividad</b>. Espera que el precio venga a ti.'
            $'ğŸŒ… <b>Buenos dÃ­as.</b>\n\nJornada nueva, mismas reglas: contexto, confluencia y plan. El institucional ya ha dejado sus huellas, toca seguirlas.'
            $'ğŸš€ <b>Arrancamos el dÃ­a.</b>\n\nRevisa tu lista A/B, define sesgo y RR mÃ­nimo. La consistencia empieza en el checklist de la maÃ±ana.'
            $'ğŸ”” <b>Buenos dÃ­as, traders.</b>\n\nHoy mandan las estructuras de valor: detecta las zonas donde el volumen se concentra y filtra el ruido.'
            $'ğŸ“ˆ <b>InvestX en marcha.</b>\n\nPrepÃ¡rate: momentum, liquidez y catalizadores. Menos operaciones, mÃ¡s calidad.'
            $'ğŸ’¡ <b>Buenos dÃ­as.</b>\n\nHoy toca recordar que la ventaja estÃ¡ en la <b>planificaciÃ³n previa</b>: niveles y escenarios definidos antes de abrir el mercado.'
            $'ğŸ§­ <b>Arranque de jornada.</b>\n\nEntrada justificada, salida planificada. Esa es la fÃ³rmula. Sin plan, no hay trade.'
            $'ğŸ” <b>Buenos dÃ­as.</b>\n\nEmpieza con visiÃ³n macro y baja a micro: cuando ambos marcos cuentan la misma historia, la probabilidad se multiplica.'
            $'ğŸ§  <b>Buenos dÃ­as, equipo.</b>\n\nObserva primero, reacciona despuÃ©s. El mercado recompensa la paciencia y castiga la prisa.'
          )

          # 10:30 â€” Tip del canal
          TIP_VARS=(
            $'ğŸ“Œ <b>TIP del canal.</b>\n\nPulsa un <b>#ticker</b> y verÃ¡s todas las menciones, informes y setups de ese activo. Contexto al instante, mejor decisiÃ³n.'
            $'ğŸ§  <b>TIP del canal.</b>\n\nAntes de entrar en una operaciÃ³n, revisa el <b>#ticker</b>. Â¿Catalizadores hoy? Â¿QuÃ© opinaba el canal ayer? Te ahorra errores.'
            $'ğŸ” <b>TIP del canal.</b>\n\nEl <b>#ticker</b> agrupa ideas, resÃºmenes y alertas de cada activo. Ãšsalo como repaso rÃ¡pido antes de abrir posiciÃ³n.'
            $'âš™ï¸ <b>TIP del canal.</b>\n\nCrea rutina: seÃ±al â†’ revisa el <b>#ticker</b> â†’ valida contexto. AsÃ­ filtras operaciones dÃ©biles.'
            $'ğŸ§­ <b>TIP del canal.</b>\n\nSi un activo estÃ¡ en tu lista A/B, pÃ¡sate por su <b>#ticker</b>: verÃ¡s niveles defendidos y setups vivos.'
            $'ğŸ“ <b>TIP del canal.</b>\n\nGuarda mensajes clave y luego accede con <b>#ticker</b>. Mantienes coherencia en tu plan.'
            $'ğŸ“š <b>TIP del canal.</b>\n\nCada <b>#ticker</b> es un mini-historial del activo: zonas, noticias y anÃ¡lisis. No lo ignores antes de tomar decisiÃ³n.'
            $'ğŸ§© <b>TIP del canal.</b>\n\nCon el <b>#ticker</b> reduces ruido: toda la info en un clic. Contexto es ventaja.'
            $'ğŸ›°ï¸ <b>TIP del canal.</b>\n\nUsa el <b>#ticker</b> para unir visiÃ³n macro y micro del mismo valor. Panorama completo en segundos.'
            $'ğŸ—‚ï¸ <b>TIP del canal.</b>\n\nTu flujo deberÃ­a ser: idea â†’ <b>#ticker</b> â†’ validar â†’ ejecutar. Proceso repetible = consistencia.'
          )

          # 22:00 â€” Cierre de mercado
          CLOSE_VARS=(
            $'ğŸŒ™ <b>Cierre de mercado.</b>\n\nAnota quÃ© setups funcionaron y dÃ³nde fallaste. La consistencia nace en el post-anÃ¡lisis.'
            $'ğŸ§© <b>Cierre de mercado.</b>\n\nHoy vimos cÃ³mo el precio defendiÃ³ zonas clave. Repasa gaps y ajusta escenarios para maÃ±ana.'
            $'ğŸ““ <b>Cierre de mercado.</b>\n\nDormir con el plan hecho = ventaja. Actualiza niveles y marca activos A/B.'
            $'ğŸ”„ <b>Cierre de mercado.</b>\n\nEscenario 1: impulso continÃºa. Escenario 2: vuelve a valor. Tenlos listos para maÃ±ana.'
            $'ğŸ’¡ <b>Cierre de mercado.</b>\n\nSimplifica: elimina lo accesorio, mantÃ©n lo que aporta. El mercado premia la claridad.'
            $'ğŸ§  <b>Cierre de mercado.</b>\n\nEscribe tu primer trade condicional para maÃ±ana. Entrar por plan, no por impulso.'
            $'ğŸ§® <b>Cierre de mercado.</b>\n\nRR real, no ideal. Ajusta objetivos a la estructura que dejÃ³ la sesiÃ³n.'
            $'ğŸŒ <b>Cierre de mercado.</b>\n\nÂ¿CambiÃ³ el contexto macro? Alinea tu sesgo con el marco mayor antes de dormir.'
            $'ğŸ“ <b>Cierre de mercado.</b>\n\nSeÃ±ala los niveles respetados hoy. Suelen ser los que importan maÃ±ana.'
            $'ğŸ—ºï¸ <b>Cierre de mercado.</b>\n\nDeja listo tu mapa: niveles, sesgo y catalizadores. MaÃ±ana toca ejecutar, no improvisar.'
          )

          # --------- Determinar SLOT si auto ---------
          if [ "$SLOT" = "auto" ]; then
            case "$HHMM_NOW" in
              "09:00") SLOT="morning";;
              "10:30") SLOT="tip";;
              "22:00") SLOT="close";;
              *) echo "Auto: ${HHMM_NOW} no tiene mensaje. No se envÃ­a."; exit 0;;
            esac
          fi

          # --------- SelecciÃ³n del mensaje ---------
          case "$SLOT" in
            morning) TEXTO="${MORNING_VARS[$IDX]}";;
            tip)     TEXTO="${TIP_VARS[$IDX]}";;
            close)   TEXTO="${CLOSE_VARS[$IDX]}";;
          esac

          echo "SLOT=${SLOT} | DOY=${DOY} | VAR=${IDX} | HHMM_NOW=${HHMM_NOW}"
          send "${TEXTO}"
