name: InvestX Telegram Scheduler

on:
  schedule:
    - cron: "*/2 * * * *"   # cada 2 min (prueba)
    - cron: "0 7 * * *"     # 09:00 Madrid
    - cron: "0 19 * * *"    # 21:00 Madrid
    - cron: "0 20 * * 1-5"  # 22:00 Madrid (L-V)
  workflow_dispatch:



jobs:
  send:
    if: github.event_name == 'schedule'   # Solo cuando se lanza por cron
    runs-on: ubuntu-latest
    steps:
      - name: Pick message
        id: pick
        run: |
          H=$(date -u +%H:%M)
          if [ "$H" = "07:00" ]; then
            echo "msg=üìä ¬°Buenos d√≠as equipo! Vamos a por los setups de hoy en InvestX." >> $GITHUB_OUTPUT
          elif [ "$H" = "19:00" ]; then
            echo "msg=üîî 21:00 ‚Äî Veamos c√≥mo cierra hoy el d√≠a para revisar los setups en InvestX." >> $GITHUB_OUTPUT
          else
            echo "msg=üõéÔ∏è Mercado cerrado equipo, empezamos desde ya a revisar setups üîç" >> $GITHUB_OUTPUT
          fi
      - name: Send Telegram message
        env:
          BOT_TOKEN: ${{ secrets.INVESTX_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          TEXT: ${{ steps.pick.outputs.msg }}
        run: |
          curl -s "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="HTML" \
            --data-urlencode text="${TEXT}"

  test:
    if: github.event_name == 'workflow_dispatch'   # Solo cuando lo lanzas manualmente
    runs-on: ubuntu-latest
    steps:
      - name: Send custom test message
        env:
          BOT_TOKEN: ${{ secrets.INVESTX_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          curl -s "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="HTML" \
            --data-urlencode text="‚ö°Ô∏è Test r√°pido enviado manualmente desde GitHub Actions üöÄ"


  heartbeat:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - run: echo "ü´Ä Heartbeat $(date -u) ‚Äî schedule OK"


