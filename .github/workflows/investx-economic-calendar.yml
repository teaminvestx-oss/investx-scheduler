name: InvestX Economic Calendar

on:
  schedule:
    - cron: "0 11 * * 1"   # Lunes 13:00 Madrid (11:00 UTC) ‚Äî semanal
    - cron: "0 11 * * 2-5" # Mar‚ÄìVie 13:00 Madrid (11:00 UTC) ‚Äî diario
  workflow_dispatch:

jobs:
  econ-calendar:
    runs-on: ubuntu-latest
    steps:
      # ----- deps -----
      - name: Install jq & pup
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y jq curl unzip
          curl -sL https://github.com/ericchiang/pup/releases/download/v0.4.0/pup_v0.4.0_linux_amd64.zip -o pup.zip
          unzip -o pup.zip
          sudo mv pup /usr/local/bin/

      # ----- 1) Obtener cookies + HTML base -----
      - name: Seed cookies & base HTML
        run: |
          set -e
          UA="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0 Safari/537.36"
          for URL in "https://es.investing.com/economic-calendar/" "https://www.investing.com/economic-calendar/"; do
            curl -sSL "$URL" \
              -H "User-Agent: $UA" \
              -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" \
              -c cookies.txt -b cookies.txt -o /dev/null || true
          done

              # ----- 2) Node + Puppeteer -----
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer
        run: |
          npm init -y
          npm i puppeteer@22

      # ----- 3) Script: abrir Investing, aplicar filtros y capturar tabla -----
      - name: Build grab script
        run: |
          cat > grab.js <<'EOF'
          const puppeteer = require('puppeteer');

          (async () => {
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox','--disable-setuid-sandbox','--lang=es-ES,es']
            });
            const page = await browser.newPage();
            await page.setUserAgent('Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124 Safari/537.36');
            await page.setViewport({ width: 1366, height: 2000, deviceScaleFactor: 2 });

            const url = 'https://es.investing.com/economic-calendar/';
            await page.goto(url, { waitUntil: 'domcontentloaded', timeout: 60000 });

            // 1) Aceptar cookies si aparece
            try {
              await page.waitForSelector('button:has-text("Aceptar")', { timeout: 6000 });
              await page.click('button:has-text("Aceptar")');
            } catch (_) {}

            // 2) Pesta√±a "Esta semana"
            try {
              await page.waitForSelector('a[data-test="calendar-thisWeek"]', { timeout: 8000 });
              await page.click('a[data-test="calendar-thisWeek"]');
            } catch (_) {}

            // 3) Abrir filtros
            try {
              await page.waitForSelector('a[data-test="filterStateButton"]', { timeout: 10000 });
              await page.click('a[data-test="filterStateButton"]');
              await page.waitForSelector('[data-test="calendar-filters"]', { timeout: 10000 });
            } catch (e) {
              console.error('No pude abrir filtros:', e.message);
            }

            // 4) Filtro pa√≠s: s√≥lo Estados Unidos
            try {
              // Limpiar selecci√≥n
              const clearSel = await page.$('button[data-test="clear-countries"]');
              if (clearSel) await clearSel.click();
            } catch (_) {}
            try {
              await page.type('input[data-test="country-search"]', 'Estados Unidos', { delay: 30 });
              await page.waitForSelector('li[role="option"]', { timeout: 8000 });
              // El primer resultado deber√≠a ser USA
              const usa = (await page.$x("//li[contains(@role,'option')]//*[contains(., 'Estados Unidos')]/ancestor::li"))[0];
              if (usa) await usa.click();
            } catch (_) {}

            // 5) Importancia: 2 y 3 estrellas
            try {
              // Desmarcar todas primero si procede
              const allImp = await page.$$('[data-test^="importance-"] input[type="checkbox"]');
              for (const cb of allImp) {
                const checked = await (await cb.getProperty('checked')).jsonValue();
                if (checked) await cb.click();
              }
              // Marcar 2 y 3
              const imp2 = await page.$('[data-test="importance-2"] input[type="checkbox"]');
              const imp3 = await page.$('[data-test="importance-3"] input[type="checkbox"]');
              if (imp2) await imp2.click();
              if (imp3) await imp3.click();
            } catch (_) {}

            // 6) Zona horaria: Madrid (si est√° disponible en selector)
            try {
              await page.select('select[name="timeZone"]', '55'); // 55 suele ser Madrid CET/CEST en Investing
            } catch (_) {}

            // 7) Aplicar filtros
            try {
              const applyBtn = await page.$('button[data-test="apply-filters"]') || await page.$('button:has-text("Aplicar")');
              if (applyBtn) await applyBtn.click();
            } catch (_) {}

            // 8) Esperar a que renderice la tabla
            await page.waitForSelector('#economicCalendarData, table.genTbl', { timeout: 20000 });

            // 9) Desplazar para que aparezca toda la tabla (altura grande)
            await page.evaluate(() => window.scrollTo(0, 0));
            await page.waitForTimeout(1000);

            const table = await page.$('#economicCalendarData') || await page.$('table.genTbl');
            if (!table) {
              console.error('No encontr√© la tabla del calendario');
              await browser.close();
              process.exit(2);
            }

            // 10) Captura del bloque (png)
            await table.screenshot({ path: 'calendar.png' });

            await browser.close();
            console.log('CAPTURA OK: calendar.png');
          })().catch(err => { console.error(err); process.exit(1); });
          EOF

      - name: Run grabber
        run: node grab.js

      # ----- 4) Enviar a Telegram -----
      - name: Send to Telegram (photo)
        if: ${{ success() }}
        env:
          BOT_TOKEN: ${{ secrets.INVESTX_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          CAPTION="üì£ Desde <b>InvestX</b> ‚Äî Calendario econ√≥mico <b>EE.UU.</b> (2‚≠êÔ∏è y 3‚≠êÔ∏è) ‚Äî semana actual.\n<i>Fuente: Investing, TZ Europe/Madrid</i>"
          curl -sS "https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto" \
            -F chat_id="${CHAT_ID}" \
            -F parse_mode="HTML" \
            -F caption="$CAPTION" \
            -F photo="@calendar.png"
