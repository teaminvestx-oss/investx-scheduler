name: InvestX Economic Calendar

on:
  schedule:
    - cron: "0 11 * * 1-5"   # Lunes-Viernes 13:00 Madrid (11:00 UTC)
  workflow_dispatch:

jobs:
  econ-calendar:
    runs-on: ubuntu-latest
    steps:
      - name: Set up job
        run: echo "Starting job..."

      - name: Install jq & pup
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl unzip
          curl -sL https://github.com/ericchiang/pup/releases/download/v0.4.0/pup_v0.4.0_linux_amd64.zip -o pup.zip
          unzip pup.zip
          sudo mv pup /usr/local/bin/

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Puppeteer
        run: npm install puppeteer

      - name: Build grab script
        run: |
          cat > grab.js <<'EOF'
          const puppeteer = require('puppeteer');

          const sleep = (ms) => new Promise(r => setTimeout(r, ms));

          async function clickByText(page, selector, texts, timeoutMs = 8000) {
            const deadline = Date.now() + timeoutMs;
            const textsLc = texts.map(t => t.toLowerCase());
            while (Date.now() < deadline) {
              const clicked = await page.evaluate(({ selector, textsLc }) => {
                const els = Array.from(document.querySelectorAll(selector));
                for (const el of els) {
                  const txt = (el.innerText || el.textContent || '').toLowerCase().trim();
                  if (textsLc.some(t => txt.includes(t))) { el.click(); return true; }
                }
                return false;
              }, { selector, textsLc });
              if (clicked) return true;
              await sleep(300);
            }
            return false;
          }

          async function selectThisWeek(page) {
            try {
              const weekSel = await page.$('a[data-test="calendar-thisWeek"]');
              if (weekSel) { await weekSel.click(); return true; }
            } catch {}
            return await clickByText(page, 'a, button', ['esta semana', 'this week'], 6000);
          }

          async function openFilters(page) {
            return await clickByText(page, 'button, a', ['filtros', 'filter'], 6000);
          }

          async function setImportance(page) {
            try {
              await page.evaluate(() => {
                document.querySelectorAll('[data-test^="importance-"] input[type="checkbox"]')
                  .forEach(cb => { if (cb.checked) cb.click(); });
              });
              await page.evaluate(() => {
                const sel = s => document.querySelector(s);
                sel('[data-test="importance-2"] input[type="checkbox"]')?.click();
                sel('[data-test="importance-3"] input[type="checkbox"]')?.click();
              });
              return true;
            } catch {}
            return false;
          }

          async function applyFilters(page) {
            try {
              const byData = await page.$('button[data-test="apply-filters"]');
              if (byData) { await byData.click(); return true; }
            } catch {}
            return await clickByText(page, 'button, a', ['aplicar', 'apply'], 5000);
          }

          (async () => {
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox','--disable-setuid-sandbox','--lang=es-ES,es']
            });
            const page = await browser.newPage();
            await page.setUserAgent('Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124 Safari/537.36');
            await page.setViewport({ width: 1440, height: 2200, deviceScaleFactor: 2 });

            await page.goto('https://es.investing.com/economic-calendar/', { waitUntil: 'domcontentloaded', timeout: 60000 });

            await clickByText(page, 'button, a', ['aceptar', 'accept all', 'aceptar todo', 'consentir'], 4000);

            await selectThisWeek(page);
            await sleep(600);

            const openedFilters = await openFilters(page);
            if (openedFilters) {
              await sleep(400);
              await setImportance(page);
              await applyFilters(page);
              await sleep(1200);
            }

            await page.waitForSelector('#economicCalendarData, table.genTbl', { timeout: 20000 }).catch(() => {});
            await sleep(500);

            const tableHandle =
              (await page.$('#economicCalendarData')) ||
              (await page.$('table.genTbl'));

            if (!tableHandle) {
              console.error('No encontr√© la tabla del calendario');
              await browser.close();
              process.exit(2);
            }

            await page.evaluate(() => window.scrollTo(0, 0));
            await sleep(400);

            await tableHandle.screenshot({ path: 'calendar.png' });
            console.log('CAPTURA OK: calendar.png');

            await browser.close();
          })().catch(err => { console.error(err); process.exit(1); });
          EOF

      - name: Run grabber
        run: node grab.js

      - name: Send to Telegram (photo)
        env:
          BOT_TOKEN: ${{ secrets.INVESTX_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto" \
            -F chat_id="${CHAT_ID}" \
            -F photo="@calendar.png" \
            -F caption="üóìÔ∏è Calendario Econ√≥mico filtrado (Importancia ‚≠ê‚≠ê y ‚≠ê‚≠ê‚≠ê, Esta semana)"
