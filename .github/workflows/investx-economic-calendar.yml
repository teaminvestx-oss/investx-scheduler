name: InvestX Economic Calendar

on:
  schedule:
    - cron: "0 11 * * 1"   # Lunes 13:00 Madrid (11:00 UTC) ‚Äî semana completa
    - cron: "0 11 * * 2-5" # Mar‚ÄìVie 13:00 Madrid (11:00 UTC) ‚Äî solo hoy
  workflow_dispatch:

jobs:
  econ-calendar:
    runs-on: ubuntu-latest
    steps:
      # ---------- Dependencias ----------
      - name: Set up job
        run: sudo apt-get update -y

      - name: Install jq & pup (compat)
        run: |
          sudo apt-get install -y jq curl unzip python3 python3-pip
          curl -sL https://github.com/ericchiang/pup/releases/download/v0.4.0/pup_v0.4.0_linux_amd64.zip -o pup.zip
          unzip pup.zip -d /usr/local/bin/
          pip3 install requests

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Puppeteer
        run: npm install puppeteer

      # ---------- Script principal ----------
          - name: Build grab script (carga + filtro h√≠brido USA + 2/3‚≠ê)
        run: |
          cat > grab.js <<'EOF'
          const puppeteer = require('puppeteer');
          const sleep = (ms) => new Promise(r => setTimeout(r, ms));

          async function clickByText(page, selector, labels, timeoutMs = 8000) {
            const until = Date.now() + timeoutMs;
            const wants = labels.map(t => t.toLowerCase());
            while (Date.now() < until) {
              const clicked = await page.evaluate(({selector, wants}) => {
                for (const el of document.querySelectorAll(selector)) {
                  const txt = (el.innerText || el.textContent || '').toLowerCase().trim();
                  if (wants.some(w => txt.includes(w))) { el.click(); return true; }
                }
                return false;
              }, {selector, wants});
              if (clicked) return true;
              await sleep(250);
            }
            return false;
          }

          async function forceLoadRows(page) {
            // Espera a que aparezcan filas y fuerza lazy loading con scrolls.
            for (let i=0;i<20;i++) {
              const rows = await page.$$eval('tr[id^="eventRowId_"], tr.js-event-item', els => els.length);
              if (rows > 10) break;
              await sleep(300);
            }
            // 2 scrolls suaves para disparar carga diferida
            for (let s=0; s<2; s++) {
              await page.evaluate(() => window.scrollBy(0, window.innerHeight*2));
              await sleep(700);
            }
            await page.evaluate(() => window.scrollTo(0, 0));
            await sleep(500);
          }

          (async () => {
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox','--disable-setuid-sandbox','--lang=es-ES,es']
            });
            const page = await browser.newPage();
            await page.setUserAgent('Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124 Safari/537.36');
            await page.setViewport({ width: 1440, height: 2400, deviceScaleFactor: 2 });

            await page.goto('https://es.investing.com/economic-calendar/', { waitUntil: 'domcontentloaded', timeout: 60000 });

            // Cookies
            await page.evaluate(() => {
              const btn = [...document.querySelectorAll("button,a")].find(b =>
                /aceptar|accept|consent/i.test((b.innerText||'').toLowerCase())
              ); btn?.click();
            });
            await sleep(800);

            // Esta semana si existe
            await clickByText(page, 'a,button', ['esta semana', 'this week'], 7000).catch(()=>{});
            await sleep(600);

            // Esperar estructura base y forzar carga
            await page.waitForSelector('table.genTbl, #economicCalendarData', { timeout: 25000 }).catch(()=>{});
            await forceLoadRows(page);

            // FILTRO H√çBRIDO: usar data-* si est√°n; si no, inferir por bandera/moneda y estrellas.
            await page.evaluate(() => {
              const isUSRow = (tr) => {
                const c = tr.getAttribute('data-country') || tr.dataset?.country || '';
                if (c === '5') return true; // Atributo fiable

                // Inferencias:
                const flagSpan = tr.querySelector('td.flagCur span');
                const flagClass = (flagSpan?.className || '').toLowerCase();
                const flagTitle = (flagSpan?.getAttribute('title') || '').toLowerCase();
                if (/usa|united\s*states/.test(flagClass) || /estados unidos|united states/.test(flagTitle)) return true;

                // columna divisa/moneda
                const curCell = tr.querySelector('td.cur') || tr.querySelector('td:nth-child(2)');
                const curTxt = (curCell?.innerText || '').trim().toUpperCase();
                if (curTxt === 'USD') return true;

                return false;
              };

              const has2or3Stars = (tr) => {
                const imp = tr.getAttribute('data-importance') || tr.dataset?.importance || '';
                if (imp === '2' || imp === '3') return true; // Atributo fiable
                // Contar estrellas renderizadas (i) dentro de td.sentiment
                const senti = tr.querySelector('td.sentiment');
                if (!senti) return false;
                // Algunas versiones dibujan vac√≠as y llenas. Contamos cualquier <i> como punto.
                const count = senti.querySelectorAll('i').length;
                return count >= 2;
              };

              // Limpiar estorbos
              for (const sel of [
                '#topBarAndAds', '.midHeader', '#banner', '.stickyFooter', '.js-consent-banner',
                'iframe', '.adsbygoogle', '.advertisement'
              ]) document.querySelectorAll(sel).forEach(e => e.remove());

              // Ocultar lo que no cumpla (USA && 2/3‚≠ê)
              const rows = document.querySelectorAll('tr[id^="eventRowId_"], tr.js-event-item');
              rows.forEach(tr => { if (!(isUSRow(tr) && has2or3Stars(tr))) tr.style.display = 'none'; });

              // Cabeceras de d√≠a solo si queda algo debajo
              const dayHeaders = Array.from(document.querySelectorAll('tr.theDay, tr.newDay, tr.dayHeader'));
              const isVisibleEvent = (el) => el.matches('tr[id^="eventRowId_"], tr.js-event-item') && el.style.display !== 'none';
              for (const hdr of dayHeaders) {
                let has = false;
                for (let sib = hdr.nextElementSibling; sib; sib = sib.nextElementSibling) {
                  if (sib.matches('tr.theDay, tr.newDay, tr.dayHeader')) break;
                  if (isVisibleEvent(sib)) { has = true; break; }
                }
                if (!has) hdr.style.display = 'none';
              }
            });

            // Captura ajustada del contenedor de tabla
            const table = await page.$('#economicCalendarData') || await page.$('table.genTbl');
            await page.evaluate(() => window.scrollTo(0, 0));
            await sleep(400);

            if (table) {
              await table.screenshot({ path: 'calendar.png' });
            } else {
              await page.screenshot({ path: 'calendar.png', fullPage: true });
            }

            console.log('‚úÖ Captura filtrada generada: calendar.png');
            await browser.close();
          })().catch(err => { console.error(err); process.exit(1); });
          EOF

      # ---------- Ejecutar scraper ----------
      - name: Run grabber
        run: node grab.js

      # ---------- Construir caption ----------
      - name: Build caption (ES/Madrid)
        run: |
          TZ=Europe/Madrid
          DOW=$(date +%u)
          if [ "$DOW" -eq 1 ]; then
            A=$(date -d "monday this week" +%Y-%m-%d)
            B=$(date -d "sunday this week" +%Y-%m-%d)
            echo "CAPTION=üóìÔ∏è Calendario USA (‚≠êÔ∏è‚≠êÔ∏è/‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è) ‚Äî Semana ${A}‚Äì${B} ¬∑ TZ Europe/Madrid ¬∑ Fuente: Investing" >> $GITHUB_ENV
          else
            HOY=$(date +%Y-%m-%d)
            echo "CAPTION=üóìÔ∏è Calendario USA (‚≠êÔ∏è‚≠êÔ∏è/‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è) ‚Äî Hoy ${HOY} ¬∑ TZ Europe/Madrid ¬∑ Fuente: Investing" >> $GITHUB_ENV
          fi

      # ---------- Enviar a Telegram ----------
      - name: Send to Telegram (Python)
        env:
          BOT_TOKEN: ${{ secrets.INVESTX_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          CAPTION: ${{ env.CAPTION }}
        run: |
          python3 - <<'PY'
          import os, requests
          bot = os.environ['BOT_TOKEN']; chat = os.environ['CHAT_ID']
          caption = os.environ.get('CAPTION','Calendario USA')
          with open("calendar.png","rb") as f:
              r = requests.post(f"https://api.telegram.org/bot{bot}/sendPhoto",
                                data={"chat_id": chat, "caption": caption, "parse_mode":"HTML"},
                                files={"photo": ("calendar.png", f, "image/png")},
                                timeout=60)
              print(r.status_code, r.text)
              r.raise_for_status()
          PY
