name: InvestX Economic Calendar

on:
  schedule:
    - cron: "0 11 * * 1-5"   # L-V 13:00 Madrid (11:00 UTC)
  workflow_dispatch:

jobs:
  econ-calendar:
    runs-on: ubuntu-latest
    steps:
      - name: Set up job
        run: echo "â–¶ï¸ Iniciando flujo Econ Calendar"

      - name: Install jq & pup (compat)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl unzip python3-requests
          curl -sL https://github.com/ericchiang/pup/releases/download/v0.4.0/pup_v0.4.0_linux_amd64.zip -o pup.zip
          unzip -o pup.zip
          sudo mv pup /usr/local/bin/

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Puppeteer
        run: npm install puppeteer

      - name: Build grab script
        run: |
          cat > grab.js <<'EOF'
          const puppeteer = require('puppeteer');
          const sleep = ms => new Promise(r => setTimeout(r, ms));

          (async () => {
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox','--disable-setuid-sandbox']
            });
            const page = await browser.newPage();
            await page.setViewport({ width: 1440, height: 2400, deviceScaleFactor: 2 });
            await page.goto('https://es.investing.com/economic-calendar/', { waitUntil: 'domcontentloaded', timeout: 60000 });

            // Aceptar cookies
            await page.evaluate(() => {
              const btn = [...document.querySelectorAll("button,a")].find(b =>
                /aceptar|accept|consent/i.test((b.innerText||'').toLowerCase())
              ); btn?.click();
            });
            await sleep(1000);

            // Filtro duro sobre el DOM: solo USA y 2/3 estrellas
            await page.waitForSelector('table', { timeout: 20000 }).catch(()=>{});
            await page.evaluate(() => {
              const keepCountry = 'USD';
              for (const tr of document.querySelectorAll('tr')) {
                const text = tr.innerText || '';
                const hasUSA = text.includes('USD');
                const stars = (tr.querySelectorAll('td.sentiment i')||[]).length;
                if (!(hasUSA && stars >= 2)) tr.style.display = 'none';
              }
            });

            // Screenshot del bloque tabla
            const table = await page.$('#economicCalendarData') || await page.$('table');
            if (table) {
              await table.screenshot({ path: 'calendar.png' });
            } else {
              await page.screenshot({ path: 'calendar.png', fullPage: true });
            }

            console.log("âœ… Captura generada");
            await browser.close();
          })().catch(err => { console.error(err); process.exit(1); });
          EOF


      - name: Run grabber
        run: node grab.js

      - name: Check screenshot exists
        run: |
          ls -lh
          test -s calendar.png

      - name: Send to Telegram (Python)
        env:
          BOT_TOKEN: ${{ secrets.INVESTX_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          python3 - <<'PY'
          import os, requests, sys
          bot = os.environ['BOT_TOKEN']
          chat = os.environ['CHAT_ID']
          photo_path = "calendar.png"
          if not os.path.exists(photo_path) or os.path.getsize(photo_path) == 0:
              print("calendar.png no existe o estÃ¡ vacÃ­o", file=sys.stderr)
              sys.exit(1)
          url = f"https://api.telegram.org/bot{bot}/sendPhoto"
          caption = "ðŸ—“ï¸ Calendario EconÃ³mico (USA, â­â­ y â­â­â­) â€” Semana actual Â· TZ Europe/Madrid Â· Fuente: Investing"
          with open(photo_path, "rb") as f:
              files = {"photo": ("calendar.png", f, "image/png")}
              data = {"chat_id": chat, "caption": caption, "parse_mode": "HTML"}
              r = requests.post(url, data=data, files=files, timeout=60)
              print(r.status_code, r.text)
              r.raise_for_status()
          PY

      - name: Done
        run: echo "âœ… Flujo completado"

