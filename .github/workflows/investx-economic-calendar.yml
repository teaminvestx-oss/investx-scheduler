name: InvestX Economic Calendar

on:
  schedule:
    - cron: "0 11 * * 1-5"   # Lunes-Viernes 13:00 Madrid (11:00 UTC)
  workflow_dispatch:

jobs:
  econ-calendar:
    runs-on: ubuntu-latest
    steps:
      - name: Set up job
        run: echo "‚ñ∂Ô∏è Iniciando flujo Econ Calendar"

      - name: Install jq & pup
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl unzip
          curl -sL https://github.com/ericchiang/pup/releases/download/v0.4.0/pup_v0.4.0_linux_amd64.zip -o pup.zip
          unzip pup.zip
          sudo mv pup /usr/local/bin/

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Puppeteer
        run: npm install puppeteer

      - name: Build grab script
        run: |
          cat > grab.js <<'EOF'
          const puppeteer = require('puppeteer');
          const sleep = (ms) => new Promise(r => setTimeout(r, ms));

          (async () => {
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox','--disable-setuid-sandbox','--lang=es-ES,es']
            });
            const page = await browser.newPage();
            await page.setUserAgent('Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124 Safari/537.36');
            await page.setViewport({ width: 1440, height: 2200, deviceScaleFactor: 2 });

            await page.goto('https://es.investing.com/economic-calendar/', { waitUntil: 'domcontentloaded', timeout: 60000 });

            // Si hay banner de cookies
            await page.evaluate(() => {
              const btn = [...document.querySelectorAll("button, a")].find(b =>
                /aceptar|accept/i.test(b.innerText)
              );
              if (btn) btn.click();
            });

            await sleep(2000);

            const tableHandle =
              (await page.$('#economicCalendarData')) ||
              (await page.$('table.genTbl'));

            if (!tableHandle) {
              console.error('‚ö†Ô∏è No encontr√© la tabla, capturo toda la p√°gina como fallback');
              await page.screenshot({ path: 'calendar.png', fullPage: true });
            } else {
              await tableHandle.screenshot({ path: 'calendar.png' });
            }

            console.log('‚úÖ Captura generada: calendar.png');
            await browser.close();
          })().catch(err => { console.error(err); process.exit(1); });
          EOF

      - name: Run grabber
        run: node grab.js

      - name: Send to Telegram (robusto)
        env:
          BOT_TOKEN: ${{ secrets.INVESTX_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          set -euo pipefail
          ls -lh
          PHOTO="$(pwd)/calendar.png"
          [ -s "$PHOTO" ] || { echo "No existe calendar.png"; exit 1; }
          API="https://api.telegram.org/bot${BOT_TOKEN}"
          CAPTION="üóìÔ∏è Calendario Econ√≥mico (‚≠ê2 y ‚≠ê3) ‚Äî semana actual. Fuente: Investing (TZ Europe/Madrid)"

          echo "‚Üí Intento 1: sendPhoto leyendo por STDIN"
          if curl -v -sS "${API}/sendPhoto" \
              --form "chat_id=${CHAT_ID}" \
              --form "photo=@-;filename=calendar.png;type=image/png" \
              --form-string "caption=${CAPTION}" \
              < "$PHOTO"; then
            echo "‚úÖ Enviado con sendPhoto"
            exit 0
          fi

          echo "‚Üí Intento 2: sendDocument leyendo por STDIN"
          if curl -v -sS "${API}/sendDocument" \
              --form "chat_id=${CHAT_ID}" \
              --form "document=@-;filename=calendar.png;type=image/png" \
              --form-string "caption=${CAPTION}" \
              < "$PHOTO"; then
            echo "‚úÖ Enviado con sendDocument"
            exit 0
          fi

          echo "‚ùå No se pudo enviar a Telegram"
          exit 1

