name: InvestX Economic Calendar

on:
  schedule:
    - cron: "0 11 * * 1"   # Lunes 13:00 Madrid (11:00 UTC) ‚Äî semana completa
    - cron: "0 11 * * 2-5" # Mar‚ÄìVie 13:00 Madrid (11:00 UTC) ‚Äî solo hoy
  workflow_dispatch:

concurrency:
  group: investx-econ-calendar
  cancel-in-progress: false

jobs:
  econ-calendar:
    runs-on: ubuntu-22.04
    timeout-minutes: 20

    steps:
      - name: System deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl unzip python3 python3-pip \
            libatk1.0-0 libatk-bridge2.0-0 libnss3 libx11-6 libx11-xcb1 \
            libxcomposite1 libxdamage1 libxext6 libxfixes3 libxrandr2 \
            libgbm1 libasound2 fonts-liberation
          python3 -m pip install --upgrade pip requests

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          check-latest: true

      - name: Install Puppeteer
        run: |
          test -f package.json || npm init -y
          npm i puppeteer

      # ---------------- SCRAPER ----------------
      - name: Build scraper (PNG + JSON)
        run: |
          cat > grab.js <<'EOF'
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          const wait = (ms)=>new Promise(r=>setTimeout(r,ms));

          async function clickTxt(p, sel, keys, ms=8000){
            const end = Date.now()+ms, wants = keys.map(x=>x.toLowerCase());
            while(Date.now()<end){
              const ok = await p.evaluate(({sel,wants})=>{
                for(const el of document.querySelectorAll(sel)){
                  const t = ((el.innerText||el.textContent||el.value||'')+'').toLowerCase().trim();
                  if(wants.some(w=>t.includes(w))){ el.click(); return true; }
                } return false;
              }, {sel, wants});
              if(ok) return true;
              await wait(250);
            }
            return false;
          }

          async function applyFilters(p){
            await clickTxt(p, 'button,a,[role="button"],input[type="button"]', ['filtro','filtros','filters'], 8000);
            await wait(600);
            await p.evaluate(()=>{
              const m = document.querySelector('.filterPopup,[class*="filterPop"]') || document;
              const cs = [...m.querySelectorAll('input[type="checkbox"][name*="country"]')];
              cs.forEach(cb=>{ cb.checked=false; cb.dispatchEvent(new Event('change',{bubbles:true})) });
              let us = cs.find(cb=>cb.value==='5') || cs.find(cb=>/estados unidos|united states|ee\.uu/i.test((cb.closest('label,li,div')?.innerText||'')));
              if(us){ us.checked=true; us.dispatchEvent(new Event('change',{bubbles:true})) }
              const imp = [...m.querySelectorAll('input[type="checkbox"][name*="importance"]')];
              imp.forEach(cb=>{ cb.checked=(cb.value==='2'||cb.value==='3'); cb.dispatchEvent(new Event('change',{bubbles:true})) });
              const btn = [...m.querySelectorAll('button,a,input[type="submit"],input[type="button"]')].find(b=>/aplicar|apply|mostrar|show/i.test((b.innerText||b.value||'')));
              btn?.click();
            });
            await wait(1200);
          }

          (async()=>{
            const browser = await puppeteer.launch({ headless:'new', args:['--no-sandbox','--disable-setuid-sandbox','--lang=es-ES,es'] });
            const page = await browser.newPage();
            await page.setUserAgent('Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124 Safari/537.36');
            await page.setExtraHTTPHeaders({'Accept-Language':'es-ES,es;q=0.9'});
            await page.setViewport({width:1440, height:2400, deviceScaleFactor:2});

            await page.goto('https://es.investing.com/economic-calendar/', {waitUntil:'domcontentloaded', timeout:60000});
            await page.evaluate(()=>{ const b=[...document.querySelectorAll("button,a,[role='button']")].find(x=>/aceptar|accept|consent|agree/i.test((x.innerText||''))); b?.click(); }).catch(()=>{});
            await wait(600);

            const dow = new Date().getDay();
            await clickTxt(page, 'a,button', dow===1?['esta semana','this week']:['hoy','today'], 6000);
            await wait(500);
            await applyFilters(page);
            await wait(600);

            // Guardamos TODOS los eventos visibles
            const data = await page.evaluate(()=>{
              const rows = [...document.querySelectorAll('tr[id^="eventRowId_"],tr.js-event-item,tr[data-event-datetime]')];

              const cleanTitle = (tr)=>{
                const pick = (...xs)=>xs.find(v=>v && v.trim && v.trim().length>0);
                const byAttr = tr.getAttribute('data-event-title');
                const aTitle = tr.querySelector('td[class*="event"] a[title]')?.getAttribute('title');
                const aria   = tr.querySelector('td[class*="event"] [aria-label]')?.getAttribute('aria-label');
                const txt1   = tr.querySelector('td[class*="event"] a')?.textContent;
                const txt2   = tr.querySelector('td[class*="event"], td.left, td:nth-child(3)')?.textContent;
                let raw = (pick(byAttr,aTitle,aria,txt1,txt2) || '').replace(/\s+/g,' ').trim();
                if (/^\d{1,2}:\d{2}$/.test(raw) || raw.length < 4) raw = '';
                return raw;
              };

              const events = [];
              for(const tr of rows){
                if (tr.style.display==='none') continue; // respeta filtro UI (USA + 2/3‚≠ê)
                const tds = tr.querySelectorAll('td');
                const time = (tds[0]?.innerText||'').trim(); // HH:MM
                const title = cleanTitle(tr);
                if(!title) continue;

                let imp = parseInt(tr.getAttribute('data-importance')||'0',10);
                if(!imp||isNaN(imp)){
                  const s = tr.querySelector('td.sentiment,td.impact,.sentiment');
                  if (s) {
                    const n = s.querySelectorAll('i,svg').length;
                    imp = n>=3?3:(n>=2?2:1);
                  } else { imp = 0; }
                }

                events.push({
                  time,
                  title,
                  importance: imp,
                  iso: tr.getAttribute('data-event-datetime') || '',
                  forecast: (tr.querySelector('td.fore,td.forecast')?.innerText||'').trim(),
                  previous: (tr.querySelector('td.prev,td.previous')?.innerText||'').trim()
                });
              }
              return { events };
            });

            const table = await page.$('#economicCalendarData') || await page.$('table.genTbl');
            if (table) { await table.screenshot({path:'calendar.png'}); }

            require('fs').writeFileSync('calendar.json', JSON.stringify(data, null, 2));
            await browser.close();
            if (!data.events.length) process.exit(0);
          })().catch(e=>{ console.error(e); process.exit(1); });
          EOF

          node grab.js

      # ---------------- CAPTION FECHA ----------------
      - name: Build caption (ES/Madrid)
        if: ${{ hashFiles('calendar.png') != '' }}
        run: |
          export TZ=Europe/Madrid
          if [ "$(date +%u)" -eq 1 ]; then
            echo "CAPTION=üóìÔ∏è Calendario USA (‚≠êÔ∏è‚≠êÔ∏è/‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è) ‚Äî Semana $(date -d 'monday this week' +%Y-%m-%d)‚Äì$(date -d 'sunday this week' +%Y-%m-%d)" >> $GITHUB_ENV
          else
            echo "CAPTION=üóìÔ∏è Calendario USA (‚≠êÔ∏è‚≠êÔ∏è/‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è) ‚Äî Hoy $(date +%Y-%m-%d)" >> $GITHUB_ENV
          fi

      # ---------------- RESUMEN ANALISTA (con agrupaciones inteligentes) ----------------
      - name: Build summary (p√°rrafos 3‚Äì5 l√≠neas)
        if: ${{ hashFiles('calendar.json') != '' }}
        run: |
          python3 - <<'PY'
          import json, re, unicodedata
          from datetime import datetime
          from zoneinfo import ZoneInfo

          tz = ZoneInfo("Europe/Madrid")
          events = json.load(open('calendar.json', encoding='utf-8')).get('events', [])

          def norm(s):
            s = unicodedata.normalize('NFKD', s or '').encode('ascii','ignore').decode()
            return re.sub(r'\s+',' ', s or '').strip().lower()

          # --- Clasificaci√≥n: datos vs discursos ---
          FED_NAMES = ['powell','waller','jefferson','cook','bowman','williams','bostic','kashkari','daly','goolsbee','barkin','logan','mester','harker','gustavo','michele','patrick']  # amplio
          POLITICIANS = ['trump','biden','harris']

          data_cpi, data_pce, data_nfp, data_gdp, data_pmi = [], [], [], [], []
          data_ca = []     # cuenta corriente / balanza
          fed_powell, fed_members = [], []
          politics = []

          for e in events:
            t = (e.get('title') or '').strip()
            tl = norm(t)
            time = (e.get('time') or '').strip()
            fore, prev = e.get('forecast'), e.get('previous')

            # discursos vs datos
            is_speech = any(k in tl for k in ['comparecencia', 'declaraciones', 'discurso', 'habla'])
            is_polit  = any(k in tl for k in POLITICIANS)

            if is_polit:
              politics.append(e); continue

            if is_speech or any(n in tl for n in FED_NAMES):
              if 'powell' in tl:
                fed_powell.append(e)
              else:
                fed_members.append(e)
              continue

            if any(k in tl for k in ['ipc','cpi']):
              data_cpi.append(e); continue
            if 'pce' in tl:
              data_pce.append(e); continue
            if any(k in tl for k in ['n√≥minas','nominas','nfp','empleo','desempleo']):
              data_nfp.append(e); continue
            if any(k in tl for k in ['pib','gdp']):
              data_gdp.append(e); continue
            if any(k in tl for k in ['pmi','ism']):
              data_pmi.append(e); continue
            if any(k in tl for k in ['cuenta corriente','balanza por cuenta corriente']):
              data_ca.append(e); continue
            # otros datos: los ignoramos para no ‚Äúensuciar‚Äù

          def pick_time_min_max(lst):
            # trabaja con HH:MM strings
            if not lst: return ('','')
            times = [x.get('time','') for x in lst if x.get('time')]
            if not times: return ('','')
            return (min(times), max(times))

          # --- Construcci√≥n de p√°rrafos ---
          paras = []

          # CPI
          if data_cpi:
            hh = data_cpi[0].get('time','--:--')
            fore, prev = data_cpi[0].get('forecast'), data_cpi[0].get('previous')
            meta = []
            if fore: meta.append(f"consenso {fore}")
            if prev: meta.append(f"anterior {prev}")
            extra = (" ‚Äî " + ", ".join(meta)) if meta else ""
            paras.append(
              f"üìå <b>IPC USA ({hh})</b>\n"
              f"La referencia clave de inflaci√≥n mensual. El mercado vigilar√° subyacente (servicios ‚Äòsupercore‚Äô y alquileres). "
              f"> consenso ‚Üí suben Tesoros (rendimientos) y USD; < consenso ‚Üí respira la curva y apoyan √≠ndices growth.{extra}"
            )

          # PCE
          if data_pce:
            hh = data_pce[0].get('time','--:--')
            fore, prev = data_pce[0].get('forecast'), data_pce[0].get('previous')
            meta = []
            if fore: meta.append(f"consenso {fore}")
            if prev: meta.append(f"anterior {prev}")
            extra = (" ‚Äî " + ", ".join(meta)) if meta else ""
            paras.append(
              f"üìå <b>PCE subyacente ({hh})</b>\n"
              f"Indicador preferido por la Fed. Desviaciones frente al consenso mueven d√≥lar y curva; sorpresa a la baja suele apoyar a renta variable.{extra}"
            )

          # NFP
          if data_nfp:
            hh = data_nfp[0].get('time','--:--')
            paras.append(
              f"üìå <b>N√≥minas no agr√≠colas ‚Äì NFP ({hh})</b>\n"
              f"Se miran creaci√≥n de empleo, salarios/hora y participaci√≥n. Fuerte + salarios altos mantiene presi√≥n de precios (yields ‚Üë, USD ‚Üë); "
              f"d√©bil abre espacio a recortes y apoya √≠ndices."
            )

          # PIB
          if data_gdp:
            hh = data_gdp[0].get('time','--:--')
            paras.append(
              f"üìå <b>PIB (GDP) ({hh})</b>\n"
              f"Pulso de la actividad. Lectura s√≥lida refuerza resiliencia y puede presionar yields; dato flojo reaviva apuestas de recortes y favorece duration."
            )

          # PMI (agregado manu/servicios)
          if data_pmi:
            tmin, tmax = pick_time_min_max(data_pmi)
            hh = tmin if tmin==tmax or not tmax else f"{tmin}‚Äì{tmax}"
            paras.append(
              f"üìå <b>PMI/ISM ({hh})</b>\n"
              f"Term√≥metro adelantado del ciclo: foco en nuevas √≥rdenes y precios pagados. >50 sostiene c√≠clicas y USD; <50 avisa de enfriamiento y favorece defensivas."
            )

          # Cuenta corriente (dato secundario √∫til si no hay estrellas)
          if data_ca and len(paras) < 3:
            hh = data_ca[0].get('time','--:--')
            fore, prev = data_ca[0].get('forecast'), data_ca[0].get('previous')
            meta = []
            if fore: meta.append(f"consenso {fore}")
            if prev: meta.append(f"anterior {prev}")
            extra = (" ‚Äî " + ", ".join(meta)) if meta else ""
            paras.append(
              f"üìå <b>Cuenta corriente ({hh})</b>\n"
              f"Dato estructural sobre el d√©ficit externo. Efecto en mercado suele ser limitado en el intrad√≠a, pero una mejora mayor a la prevista puede aliviar presi√≥n sobre el USD a medio plazo.{extra}"
            )

          # Discursos Powell
          if fed_powell:
            tmin, tmax = pick_time_min_max(fed_powell)
            hh = tmin if tmin==tmax or not tmax else f"{tmin}‚Äì{tmax}"
            paras.append(
              f"üìå <b>Decisi√≥n/comparecencia de Powell ({hh})</b>\n"
              f"Mercado pendiente del tono del presidente de la Fed. Hawkish ‚Üí condiciones financieras m√°s duras (USD/yields ‚Üë, bolsa vol√°til); "
              f"dovish ‚Üí alivio para equities y cr√©dito."
            )

          # Discursos miembros secundarios (agregados con rango)
          if fed_members:
            tmin, tmax = pick_time_min_max(fed_members)
            hh = tmin if tmin==tmax or not tmax else f"{tmin}‚Äì{tmax}"
            # intenta listar hasta 3 apellidos distintos
            names = []
            for e in fed_members:
              tl = norm(e.get('title',''))
              m = re.findall(r'(bowman|bostic|williams|kashkari|waller|daly|goolsbee|barkin|logan|mester|harker)', tl)
              if m:
                names.append(m[0].capitalize())
            uniq = []
            for n in names:
              if n not in uniq:
                uniq.append(n)
            who = f" ({', '.join(uniq[:3])})" if uniq else ""
            paras.append(
              f"üìå <b>Miembros de la Fed{who} ({hh})</b>\n"
              f"Intervenciones con menor peso que Powell, salvo mensajes que contradigan la l√≠nea oficial. Un tono m√°s hawkish podr√≠a presionar al USD y a la curva; impacto normalmente acotado."
            )

          # Pol√≠ticos (ruido)
          if politics and len(paras) < 4:
            tmin, tmax = pick_time_min_max(politics)
            hh = tmin if tmin==tmax or not tmax else f"{tmin}‚Äì{tmax}"
            paras.append(
              f"üìå <b>Declaraciones pol√≠ticas ({hh})</b>\n"
              f"Posible ruido de corto plazo. Su impacto en precios suele ser transitorio salvo anuncios con implicaciones fiscales o regulatorias claras."
            )

          # Selecci√≥n final: m√°ximo 4 p√°rrafos (semana) o 3 (d√≠a)
          weekly = datetime.now(tz).isoweekday()==1
          limit = 4 if weekly else 3
          paras = paras[:limit]

          if not paras:
            open('summary.txt','w').close(); raise SystemExit(0)

          text = "üì∞ <b>Resumen principales noticias</b>\n\n" + "\n\n".join(paras)
          open('summary.txt','w',encoding='utf-8').write(text)

          # Debug en logs
          print("=== DEBUG ===")
          for p in paras: 
            print(p.split("\\n")[0])
          PY

      # ---------------- ENV√çO A TELEGRAM (2 MENSAJES) ----------------
      - name: Send image to Telegram
        if: ${{ hashFiles('calendar.png') != '' }}
        env:
          BOT_TOKEN: ${{ secrets.INVESTX_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          CAPTION: ${{ env.CAPTION }}
        run: |
          python3 - <<'PY'
          import os,requests
          bot=os.environ['BOT_TOKEN']; chat=os.environ['CHAT_ID']
          caption=os.environ.get('CAPTION','Calendario USA')
          with open("calendar.png","rb") as f:
            r=requests.post(
              f"https://api.telegram.org/bot{bot}/sendPhoto",
              data={"chat_id":chat,"caption":caption,"parse_mode":"HTML"},
              files={"photo":("calendar.png",f,"image/png")}, timeout=90
            ); print(r.status_code,r.text); r.raise_for_status()
          PY

      - name: Send summary to Telegram (mensaje separado)
        if: ${{ hashFiles('summary.txt') != '' }}
        env:
          BOT_TOKEN: ${{ secrets.INVESTX_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          python3 - <<'PY'
          import os,requests
          bot=os.environ['BOT_TOKEN']; chat=os.environ['CHAT_ID']
          text=open('summary.txt','r',encoding='utf-8').read().strip()
          if text:
            r=requests.post(
              f"https://api.telegram.org/bot{bot}/sendMessage",
              data={"chat_id":chat,"text":text,"parse_mode":"HTML","disable_web_page_preview":True},
              timeout=90
            ); print(r.status_code,r.text); r.raise_for_status()
          PY
