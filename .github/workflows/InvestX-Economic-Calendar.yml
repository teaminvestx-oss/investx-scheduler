name: InvestX Economic Calendar

on:
  schedule:
    - cron: "0 11 * * 1"   # Lunes 13:00 Madrid (11:00 UTC) ‚Äî semana completa
    - cron: "0 11 * * 2-5" # Mar‚ÄìVie 13:00 Madrid (11:00 UTC) ‚Äî solo hoy
  workflow_dispatch:

concurrency:
  group: investx-econ-calendar
  cancel-in-progress: false

jobs:
  econ-calendar:
    runs-on: ubuntu-22.04
    timeout-minutes: 20

    steps:
      - name: System deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl unzip python3 python3-pip \
            libatk1.0-0 libatk-bridge2.0-0 libnss3 libx11-6 libx11-xcb1 \
            libxcomposite1 libxdamage1 libxext6 libxfixes3 libxrandr2 \
            libgbm1 libasound2 fonts-liberation
          python3 -m pip install --upgrade pip requests

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          check-latest: true

      - name: Install Puppeteer
        run: |
          test -f package.json || npm init -y
          npm i puppeteer

      - name: Build scraper (PNG + JSON)  # PATCH
        run: |
          cat > grab.js <<'EOF'
          const puppeteer=require('puppeteer');const fs=require('fs');
          const wait=ms=>new Promise(r=>setTimeout(r,ms));

          async function clickTxt(p,sel,keys,ms=8000){
            const end=Date.now()+ms, want=keys.map(x=>x.toLowerCase());
            while(Date.now()<end){
              const ok=await p.evaluate(({sel,want})=>{
                for(const el of document.querySelectorAll(sel)){
                  const t=((el.innerText||el.textContent||el.value||'')+'').toLowerCase().trim();
                  if(want.some(w=>t.includes(w))){el.click();return true;}
                } return false;
              },{sel,want});
              if(ok) return true; await wait(250);
            } return false;
          }

          async function openAndFilter(p){
            // abrir filtros
            await clickTxt(p,'button,a,[role="button"],input[type="button"]',['filtro','filtros','filters'],8000);
            await wait(600);
            // marcar USA + 2/3 estrellas
            await p.evaluate(()=>{
              const modal=document.querySelector('.filterPopup,[class*="filterPop"]')||document;
              const cbs=[...modal.querySelectorAll('input[type="checkbox"][name*="country"]')];
              cbs.forEach(cb=>{cb.checked=false;cb.dispatchEvent(new Event('change',{bubbles:true}))});
              let us=cbs.find(cb=>cb.value==='5')||
                     cbs.find(cb=>/estados unidos|united states|ee\.uu/i.test((cb.closest('label,li,div')?.innerText||'')));
              if(us){us.checked=true;us.dispatchEvent(new Event('change',{bubbles:true}))}
              const imp=[...modal.querySelectorAll('input[type="checkbox"][name*="importance"]')];
              imp.forEach(cb=>{cb.checked=(cb.value==='2'||cb.value==='3');cb.dispatchEvent(new Event('change',{bubbles:true}))});
              const btn=[...modal.querySelectorAll('button,a,input[type="submit"],input[type="button"]')].find(b=>/aplicar|apply|mostrar|show/i.test((b.innerText||b.value||''))); btn?.click();
            });
            await wait(1200);
          }

          function cleanTitle(tr){
            const pick = (...xs)=>xs.find(Boolean);
            const byAttr = tr.getAttribute('data-event-title');
            const aTitle = tr.querySelector('td.event a[title]')?.getAttribute('title');
            const aria   = tr.querySelector('td.event [aria-label]')?.getAttribute('aria-label');
            const txtSel = tr.querySelector('td.event, td.left, td.event a')?.textContent;
            const raw = (pick(byAttr,aTitle,aria,txtSel)||'').replace(/\s+/g,' ').trim();
            // descarta textos que son horas o vac√≠os
            if (/^\d{1,2}:\d{2}$/.test(raw) || raw.length < 4) return '';
            return raw;
          }

          function parseEventRow(tr){
            const tds=tr.querySelectorAll('td');
            const time=(tds[0]?.innerText||'').trim();
            let title=cleanTitle(tr);
            // fallback: intenta otra celda, pero evita coger la hora
            if(!title){
              const alt=(tds[2]?.innerText||'').trim();
              title = (/^\d{1,2}:\d{2}$/.test(alt)?'':alt);
            }
            // importancia
            let imp = parseInt(tr.getAttribute('data-importance')||'0',10);
            if(!imp||isNaN(imp)){
              const s=tr.querySelector('td.sentiment,td.impact,.sentiment');
              if(s){ const n=s.querySelectorAll('i,svg').length; imp = n>=3?3:(n>=2?2:1); }
            }
            // iso: puede venir vac√≠o o ser epoch; guardamos string tal cual
            const iso = tr.getAttribute('data-event-datetime') || '';
            const forecast=(tr.querySelector('td.fore,td.forecast')?.innerText||'').trim();
            const previous=(tr.querySelector('td.prev,td.previous')?.innerText||'').trim();
            return { time, title, importance: imp||0, iso, forecast, previous };
          }

          (async()=>{
            const browser=await puppeteer.launch({headless:'new',args:['--no-sandbox','--disable-setuid-sandbox','--lang=es-ES,es']});
            const page=await browser.newPage();
            await page.setUserAgent('Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124 Safari/537.36');
            await page.setExtraHTTPHeaders({'Accept-Language':'es-ES,es;q=0.9'});
            await page.setViewport({width:1440,height:2400,deviceScaleFactor:2});
            await page.goto('https://es.investing.com/economic-calendar/',{waitUntil:'domcontentloaded',timeout:60000});
            await page.evaluate(()=>{const b=[...document.querySelectorAll("button,a,[role='button']")].find(x=>/aceptar|accept|consent|agree/i.test((x.innerText||''))); b?.click();}).catch(()=>{});
            await wait(600);
            const dow=new Date().getDay();
            await clickTxt(page,'a,button', dow===1?['esta semana','this week']:['hoy','today'], 6000);
            await wait(500);
            await openAndFilter(page);
            await wait(600);

            // Oculta ruido y recoge filas visibles
            await page.evaluate(()=>{
              document.querySelectorAll('#topBarAndAds,.midHeader,#banner,.stickyFooter,.js-consent-banner,iframe,.adsbygoogle,.advertisement').forEach(e=>e.remove());
              // quita cabeceras sin hijos
              const isEvent = el => el.matches('tr[id^="eventRowId_"],tr.js-event-item,tr[data-event-datetime]');
              [...document.querySelectorAll('tr.theDay,tr.newDay,tr.dayHeader')].forEach(h=>{
                let ok=false; for(let n=h.nextElementSibling;n;n=n.nextElementSibling){ if(n.matches('tr.theDay,tr.newDay,tr.dayHeader')) break; if(isEvent(n) && n.style.display!=='none'){ ok=true; break; } }
                if(!ok) h.style.display='none';
              });
            });

            const rows = await page.$$eval('tr[id^="eventRowId_"],tr.js-event-item,tr[data-event-datetime]', els =>
              els.filter(tr=>tr.style.display!=='none').map(tr=>{
                const tds=tr.querySelectorAll('td');
                // devolvemos lo m√≠nimo; la l√≥gica fina va en parseEventRow del lado Node
                return tr.outerHTML;
              })
            );

            // Re-parse en Node para t√≠tulo robusto
            const { JSDOM } = await import('jsdom').catch(()=>({JSDOM:null}));
            let events=[];
            if(JSDOM){
              for(const html of rows){
                const dom=new JSDOM(html); const tr=dom.window.document.querySelector('tr');
                // reinyecta helpers locales
                tr.querySelector = tr.querySelector.bind(tr);
                tr.querySelectorAll = tr.querySelectorAll.bind(tr);
                const tds=tr.querySelectorAll('td'); // warm-up
                // replicate parseEventRow here:
                const pick=(...xs)=>xs.find(Boolean);
                const time=(tds[0]?.textContent||'').trim();
                const byAttr=tr.getAttribute('data-event-title');
                const aTitle=tr.querySelector('td.event a[title]')?.getAttribute('title');
                const aria  =tr.querySelector('td.event [aria-label]')?.getAttribute('aria-label');
                const txtSel=tr.querySelector('td.event, td.left, td.event a')?.textContent;
                let title=(pick(byAttr,aTitle,aria,txtSel)||'').replace(/\s+/g,' ').trim();
                if(/^\d{1,2}:\d{2}$/.test(title)||title.length<4){ const alt=(tds[2]?.textContent||'').trim(); title = (/^\d{1,2}:\d{2}$/.test(alt)?'':alt); }
                let imp=parseInt(tr.getAttribute('data-importance')||'0',10); if(!imp||isNaN(imp)){ const s=tr.querySelector('td.sentiment,td.impact,.sentiment'); if(s){const n=s.querySelectorAll('i,svg').length; imp=n>=3?3:(n>=2?2:1);} }
                const iso=tr.getAttribute('data-event-datetime')||'';
                const forecast=(tr.querySelector('td.fore,td.forecast')?.textContent||'').trim();
                const previous=(tr.querySelector('td.prev,td.previous')?.textContent||'').trim();
                events.push({time,title,importance:imp||0,iso,forecast,previous});
              }
            }

            // screenshot
            const table=await page.$('#economicCalendarData')||await page.$('table.genTbl');
            if(table) await table.screenshot({path:'calendar.png'});

            fs.writeFileSync('calendar.json', JSON.stringify({events}, null, 2));
            await browser.close();
            if(!events.length) process.exit(0);
          })().catch(e=>{console.error(e);process.exit(1);});
          EOF

          # jsdom para el parse fino del t√≠tulo
          test -f package.json || npm init -y
          npm i puppeteer jsdom
          node grab.js

      - name: Build caption (ES/Madrid)
        if: ${{ hashFiles('calendar.png') != '' }}
        run: |
          export TZ=Europe/Madrid
          if [ "$(date +%u)" -eq 1 ]; then
            echo "CAPTION=üóìÔ∏è Calendario USA (‚≠êÔ∏è‚≠êÔ∏è/‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è) ‚Äî Semana $(date -d 'monday this week' +%Y-%m-%d)‚Äì$(date -d 'sunday this week' +%Y-%m-%d)" >> $GITHUB_ENV
          else
            echo "CAPTION=üóìÔ∏è Calendario USA (‚≠êÔ∏è‚≠êÔ∏è/‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è) ‚Äî Hoy $(date +%Y-%m-%d)" >> $GITHUB_ENV
          fi

      - name: Build summary (3‚Äì5 eventos, p√°rrafos)  # PATCH
        if: ${{ hashFiles('calendar.json') != '' }}
        run: |
          python3 - <<'PY'
          import json, re, unicodedata
          from datetime import datetime
          from zoneinfo import ZoneInfo
          tz = ZoneInfo("Europe/Madrid")

          data = json.load(open('calendar.json', encoding='utf-8'))
          evts = data.get('events', [])

          def norm(s):
            s = unicodedata.normalize('NFKD', s or '').encode('ascii','ignore').decode()
            s = re.sub(r'\s+',' ', s).strip().lower()
            return s

          # ranking por palabra clave + importancia
          def score(e):
            t = norm(e.get('title',''))
            imp = int(e.get('importance') or 0)
            kw = [
              (('fed','fomc','powell'), 100),
              (('ipc','cpi','inflacion','pce'), 90),
              (('nominas','empleo','nfp','desempleo'), 80),
              (('pib','gdp'), 70),
              (('pmi','ism'), 60),
              ((), imp) # fallback
            ]
            for keys, base in kw:
              if keys and any(k in t for k in keys): return base + imp
            return imp

          # limpia eventos sin t√≠tulo
          evts = [e for e in evts if e.get('title') and len(e['title'])>3]

          # de-dup por t√≠tulo normalizado
          seen=set(); dedup=[]
          for e in evts:
            t = norm(e['title'])
            if t in seen: continue
            seen.add(t); dedup.append(e)
          evts = dedup

          # ordena y recorta
          evts.sort(key=lambda e: (-score(e), e.get('time','')))
          take = 5 if datetime.now(tz).isoweekday()==1 else 3
          sel = evts[:take]

          if not sel:
            open('summary.txt','w').close(); raise SystemExit(0)

          def pretty_time(e):
            # si no hay iso fiable, usa la hora tal cual del calendario (m√°s seguro que nuestro parse)
            hhmm = (e.get('time') or '').strip()
            if hhmm and re.match(r'^\d{1,2}:\d{2}$', hhmm):
              # a√±ade d√≠a corto si viene en iso (opcional)
              return hhmm
            # fallback iso ‚Üí hora local
            iso = e.get('iso') or ''
            try:
              dt = datetime.fromisoformat(iso.replace('Z','+00:00')).astimezone(tz)
              return dt.strftime('%a %H:%M')
            except:
              return hhmm or '--:--'

          def para(e):
            t = e['title'].strip()
            tlow = norm(t)
            hhmm = pretty_time(e)
            prev = e.get('previous')
            fore = e.get('forecast')

            lead = f"üìå <b>{t} ({hhmm})</b>"
            ctx=""
            if any(k in tlow for k in ['ipc','cpi']):
              ctx="Dato de inflaci√≥n clave para la Fed. Sorpresa al alza endurecer√≠a expectativas de tipos y apoyar√≠a al USD/yields; a la baja favorecer√≠a a growth y a la compresi√≥n de la curva."
            elif 'pce' in tlow:
              ctx="PCE subyacente, referencia preferida por la Fed. Desviaciones frente al consenso suelen mover la curva y el d√≥lar de forma notable."
            elif any(k in tlow for k in ['fed','fomc','powell']):
              ctx="Comunicaci√≥n de pol√≠tica monetaria. El foco estar√° en el comunicado, dot plot y tono de Powell; un mensaje hawkish endurece condiciones financieras, uno dovish apoya a equities."
            elif any(k in tlow for k in ['nominas','empleo','nfp','desempleo']):
              ctx="Lectura de mercado laboral. Fortaleza ‚Üí presi√≥n en salarios y yields; debilidad ‚Üí m√°s probabilidad de recortes y apoyo a la renta variable."
            elif any(k in tlow for k in ['pib','gdp']):
              ctx="Pulso de actividad macro. Dato fuerte refuerza resiliencia y puede presionar yields; flojo reaviva apuestas de est√≠mulo/recortes."
            elif any(k in tlow for k in ['pmi','ism']):
              ctx="Indicador adelantado de ciclo. Ca√≠das bajo 50 alertan sobre desaceleraci√≥n; lecturas s√≥lidas sostienen c√≠clicas y el USD."
            else:
              ctx="Catalizador potencial para USD, bonos y equity en funci√≥n de la sorpresa frente al consenso."

            meta=[]
            if fore: meta.append(f"consenso {fore}")
            if prev: meta.append(f"anterior {prev}")
            extra=(" ‚Äî "+", ".join(meta)) if meta else ""
            return f"{lead}\n{ctx}{extra}"

          lines=["üì∞ <b>Resumen principales noticias</b>"]
          for e in sel:
            lines.append(para(e))
          # l√≠mite ~12 l√≠neas ‚Üí deja 3‚Äì5 p√°rrafos; no recortamos cada p√°rrafo
          open('summary.txt','w',encoding='utf-8').write("\n\n".join(lines))
          PY


      - name: Send to Telegram
        if: ${{ hashFiles('calendar.png') != '' && hashFiles('summary.txt') != '' }}
        env:
          BOT_TOKEN: ${{ secrets.INVESTX_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          CAPTION: ${{ env.CAPTION }}
        run: |
          python3 - <<'PY'
          import os,requests
          bot=os.environ['BOT_TOKEN'];chat=os.environ['CHAT_ID']
          caption=os.environ.get('CAPTION','Calendario USA')
          summary=open('summary.txt','r',encoding='utf-8').read().strip()
          if summary: caption=(caption+"\n\n"+summary)[:1024]
          with open("calendar.png","rb") as f:
            r=requests.post(f"https://api.telegram.org/bot{bot}/sendPhoto",
              data={"chat_id":chat,"caption":caption,"parse_mode":"HTML"},
              files={"photo":("calendar.png",f,"image/png")},timeout=90)
            print(r.status_code,r.text);r.raise_for_status()
          PY

