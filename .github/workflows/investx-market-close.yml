name: InvestX Market Close

on:
  schedule:
    - cron: "0 21 * * 1-5"   # 23:00 Madrid (21:00 UTC), L‚ÄìV
  workflow_dispatch:

jobs:
  market-close:
    runs-on: ubuntu-22.04

    steps:
      - name: System deps
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y \
            jq curl unzip python3 python3-pip \
            libatk1.0-0 libatk-bridge2.0-0 libnss3 libx11-6 libx11-xcb1 \
            libxcomposite1 libxdamage1 libxext6 libxfixes3 libxrandr2 \
            libgbm1 libasound2 fonts-liberation

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer
        run: npm i puppeteer@22

      # ---------- Screenshot Heatmap ----------
      - name: Build screenshot script
        run: |
          cat > screenshot.js <<'EOF'
          const puppeteer = require('puppeteer');
          const sleep = ms => new Promise(r=>setTimeout(r,ms));

          async function waitForCanvasReady(page, timeoutMs=70000) {
            const t0 = Date.now();
            while (Date.now()-t0 < timeoutMs) {
              const ok = await page.evaluate(() => {
                const cs = Array.from(document.querySelectorAll('canvas'));
                if (!cs.length) return false;
                const big = cs.map(c=>({w:c.width,h:c.height,bb:c.getBoundingClientRect()}))
                              .sort((a,b)=>b.w*b.h-a.w*a.h)[0];
                return big && big.w>=800 && big.h>=500;
              });
              if (ok) return true;
              await sleep(500);
            }
            return false;
          }

          (async () => {
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox','--disable-setuid-sandbox','--disable-dev-shm-usage','--lang=es-ES,es']
            });
            const page = await browser.newPage();
            await page.setViewport({ width: 1600, height: 1200, deviceScaleFactor: 2 });
            await page.setUserAgent('Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124 Safari/537.36');

            const url = 'https://finviz.com/map.ashx?t=sec&st=d1';
            let ready=false, tries=0;
            while(!ready && tries<3){
              tries++;
              await page.goto(url, { waitUntil: 'domcontentloaded', timeout: 60000 }).catch(()=>{});
              await page.evaluate(()=>{
                const b=[...document.querySelectorAll('button,a')].find(x=>/accept|agree|consent|aceptar/i.test((x.innerText||'')+''));
                b?.click();
              }).catch(()=>{});
              ready = await waitForCanvasReady(page, 70000);
              if(!ready) await sleep(2000);
            }

            const clip = await page.evaluate(() => {
              const cs = Array.from(document.querySelectorAll('canvas'));
              const big = cs.map(c=>{
                const r=c.getBoundingClientRect();
                return {x:Math.max(0,r.x),y:Math.max(0,r.y),w:r.width,h:r.height,area:r.width*r.height};
              }).filter(b=>b.area>120000);
              if(!big.length) return null;
              const x0=Math.floor(Math.min(...big.map(b=>b.x)));
              const y0=Math.floor(Math.min(...big.map(b=>b.y)))-60;
              const x1=Math.ceil(Math.max(...big.map(b=>b.x+b.w)));
              const y1=Math.ceil(Math.max(...big.map(b=>b.y+b.h)))+40;
              return {x:Math.max(0,x0), y:Math.max(0,y0), width:x1-x0, height:y1-y0};
            });

            if(clip && clip.width>0 && clip.height>0) {
              await page.screenshot({ path: 'heatmap.png', clip });
            } else {
              await page.screenshot({ path: 'heatmap.png', fullPage: true });
            }
            await browser.close();
          })().catch(e=>{console.error(e); process.exit(0);});
          EOF

      - name: Run screenshot
        run: node screenshot.js

      # ---------- Summary + Opinion ----------
      - name: Build summary script
        run: |
          cat > summary.js <<'EOF'
          const puppeteer = require('puppeteer');
          const sleep = ms => new Promise(r=>setTimeout(r,ms));

          const fmtPct = s => {
            const m = /(-?\d+(?:\.\d+)?)%/.exec(s || '');
            return m ? parseFloat(m[1]) : null;
          };

          async function grabChange(page, ticker){ // SPY/QQQ/DIA como proxy √≠ndices
            const url=`https://finviz.com/quote.ashx?t=${ticker}`;
            await page.goto(url, {waitUntil:'domcontentloaded', timeout:60000}).catch(()=>{});
            await page.waitForSelector('.snapshot-table2,.table-dark-row', {timeout:10000}).catch(()=>{});
            // cambio % suele estar cerca del precio en cabecera
            const text = await page.evaluate(() => {
              const h = document.querySelector('#quote-top') || document.querySelector('.quote-header_ticker-wrapper') || document.body;
              return h.innerText;
            }).catch(()=> '');
            let pct = null;
            // fallback: buscar en toda la p√°gina el primer "%".
            if(text) {
              const m = text.match(/-?\d+(?:\.\d+)?%/g);
              if(m && m.length) pct = parseFloat(m[0].replace('%',''));
            }
            return pct;
          }

          async function grabSectors(page){
            const url='https://finviz.com/groups.ashx?g=sector&v=210'; // 1-Day Perf
            await page.goto(url, {waitUntil:'domcontentloaded', timeout:60000}).catch(()=>{});
            await page.waitForSelector('table.table-light', {timeout:15000}).catch(()=>{});
            return await page.evaluate(() => {
              const rows = [...document.querySelectorAll('table.table-light tr')].slice(1);
              const data = rows.map(r=>{
                const tds=[...r.querySelectorAll('td')].map(td=>td.innerText.trim());
                // [Sector, Perf Day, ...]
                return {name: tds[1]||tds[0], day: tds[2]||tds[1]};
              }).filter(x=>x.name && x.day && x.day.includes('%'));
              const by = data.map(d=>({name:d.name, pct: parseFloat(d.day.replace('%',''))}));
              const top = [...by].sort((a,b)=>b.pct-a.pct).slice(0,2);
              const worst = [...by].sort((a,b)=>a.pct-b.pct).slice(0,2);
              return {top, worst};
            });
          }

          async function grabMovers(page, order){ // order: 'desc' (winners) | 'asc' (losers)
            // Screener S&P500 orden por cambio d√≠a
            const o = order==='desc' ? '-change' : 'change';
            const url = `https://finviz.com/screener.ashx?v=111&f=idx_sp500&o=${o}`;
            await page.goto(url, {waitUntil:'domcontentloaded', timeout:60000}).catch(()=>{});
            await page.waitForSelector('table.table-light', {timeout:15000}).catch(()=>{});
            return await page.evaluate(() => {
              const rows = [...document.querySelectorAll('table.table-light tr')].slice(1,6);
              return rows.map(r=>{
                const tds=[...r.querySelectorAll('td')].map(td=>td.innerText.trim());
                // columnas tip: [No, Ticker, Company, Sector, Industry, Country, Market Cap, Price, Change, Volume]
                return {t: tds[1], c: tds[2], ch: tds[8]};
              }).filter(Boolean).slice(0,3);
            });
          }

          async function grabNews(page){
            const url = 'https://finviz.com/news.ashx';
            await page.goto(url, {waitUntil:'domcontentloaded', timeout:60000}).catch(()=>{});
            // tomamos el primer titular del feed principal
            const item = await page.evaluate(() => {
              const row = document.querySelector('.nn-tab .news-item-row, .news-item-row, table#news-table tr'); 
              if(!row) return null;
              const a = row.querySelector('a');
              const src = row.querySelector('.news-source')?.innerText || '';
              const title = (a?.innerText || '').trim();
              return title ? `${title}${src ? ' ‚Äî '+src : ''}` : null;
            });
            return item;
          }

          (async () => {
            const browser = await puppeteer.launch({
              headless:'new',
              args:['--no-sandbox','--disable-setuid-sandbox','--disable-dev-shm-usage','--lang=es-ES,es']
            });
            const page = await browser.newPage();
            await page.setViewport({ width: 1400, height: 1000, deviceScaleFactor: 2 });
            await page.setUserAgent('Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124 Safari/537.36');

            // √çndices (proxies)
            const [sp, nq, dj] = await Promise.all([
              grabChange(page, 'SPY'),
              grabChange(page, 'QQQ'),
              grabChange(page, 'DIA'),
            ]);

            // Sectores
            const sectors = await grabSectors(page).catch(()=>null);

            // Movers
            const winners = await grabMovers(page, 'desc').catch(()=>[]);
            const losers  = await grabMovers(page, 'asc').catch(()=>[]);

            // Noticia del d√≠a
            const headline = await grabNews(page).catch(()=>null);

            await browser.close();

            // Opini√≥n autom√°tica simple
            const riskOff = [sp,nq,dj].every(v => typeof v === 'number' && v < 0);
            const techWeak = sectors?.worst?.some(s=>/technology/i.test(s.name)) ? true : false;
            const defensivesUp = sectors?.top?.some(s=>/(utilities|consumer defensive|healthcare)/i.test(s.name)) ? true : false;

            let opinion = 'Sesi√≥n mixta.';
            if (riskOff) opinion = 'Sesgo risk-off, cierres en rojo en los tres √≠ndices.';
            else if (techWeak && defensivesUp) opinion = 'Rotaci√≥n defensiva: presi√≥n en tecnolog√≠a mientras defensivos lideran.';
            else if ((sp??0)>0 && (nq??0)>0) opinion = 'Apuesta por riesgo: tecnolog√≠a y growth tiran del mercado.';
            else if ((sp??0)<0 && (nq??0)<0) opinion = 'Venta en renta variable con debilidad en crecimiento.';

            const d = new Date().toLocaleDateString('es-ES', { timeZone: 'Europe/Madrid' });

            const idxLine = `‚Ä¢ S&P500: ${sp?.toFixed(2) ?? 'N/A'}% | Nasdaq: ${nq?.toFixed(2) ?? 'N/A'}% | Dow: ${dj?.toFixed(2) ?? 'N/A'}%`;

            const secBest = sectors?.top?.map(s=>`${s.name} ${s.pct.toFixed(2)}%`).join(', ') || '‚Äî';
            const secWorst = sectors?.worst?.map(s=>`${s.name} ${s.pct.toFixed(2)}%`).join(', ') || '‚Äî';

            const winStr = winners.map(x=>`${x.t} ${x.ch}`).join(', ') || '‚Äî';
            const losStr = losers.map(x=>`${x.t} ${x.ch}`).join(', ') || '‚Äî';

            const newsStr = headline ? `üóûÔ∏è Noticia: ${headline}` : '';

            const caption = `
üìä **Cierre de mercado ‚Äî ${d}**
${idxLine}
‚Ä¢ Sectores destacados: ${secBest}
‚Ä¢ Peores sectores: ${secWorst}
‚Ä¢ Top ganadores (S&P500): ${winStr}
‚Ä¢ Top perdedores (S&P500): ${losStr}

üí° *Opini√≥n*: ${opinion}
${newsStr}
`;

            require('fs').writeFileSync('caption.txt', caption.trim(), 'utf8');


      - name: Run summary
        run: node summary.js

      # ---------- Env√≠o a Telegram ----------
      - name: Send to Telegram
        env:
          BOT_TOKEN: ${{ secrets.INVESTX_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          CAPTION="$(cat caption.txt)"
          python3 - <<'PY'
          import os, requests
          bot = os.environ['BOT_TOKEN']
          chat = os.environ['CHAT_ID']
          with open("caption.txt","r") as f: caption=f.read()
          with open("heatmap.png","rb") as f:
              r = requests.post(
                  f"https://api.telegram.org/bot{bot}/sendPhoto",
                  data={"chat_id": chat, "caption": caption, "parse_mode":"Markdown"},
                  files={"photo": ("heatmap.png", f, "image/png")},
                  timeout=120
              )
              print(r.status_code, r.text)
              r.raise_for_status()
          PY
