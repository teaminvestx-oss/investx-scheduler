name: InvestX Market Close

on:
  schedule:
    - cron: "0 21 * * 1-5"   # 23:00 Madrid (21:00 UTC), L‚ÄìV
  workflow_dispatch:

jobs:
  market-close:
    runs-on: ubuntu-22.04

    steps:
      # ---------- Dependencias del sistema ----------
      - name: Install system deps
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y \
            jq curl unzip python3 python3-pip \
            libatk1.0-0 libatk-bridge2.0-0 libnss3 libx11-6 libx11-xcb1 \
            libxcomposite1 libxdamage1 libxext6 libxfixes3 libxrandr2 \
            libgbm1 libasound2 fonts-liberation ca-certificates

      # ---------- Node / Puppeteer ----------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer
        run: npm i puppeteer@22

      # ---------- Captura del heatmap ----------
      - name: Build screenshot script
        run: |
          cat > screenshot.js <<'EOF'
          const puppeteer = require('puppeteer');
          const sleep = ms => new Promise(r=>setTimeout(r,ms));

          async function waitForCanvasReady(page, timeoutMs=70000) {
            const t0 = Date.now();
            while (Date.now()-t0 < timeoutMs) {
              const ok = await page.evaluate(() => {
                const cs = Array.from(document.querySelectorAll('canvas'));
                if (!cs.length) return false;
                const big = cs.map(c=>({w:c.width,h:c.height,bb:c.getBoundingClientRect()}))
                              .sort((a,b)=>b.w*b.h-a.w*a.h)[0];
                return big && big.w>=800 && big.h>=500;
              });
              if (ok) return true;
              await sleep(500);
            }
            return false;
          }

          (async () => {
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox','--disable-setuid-sandbox','--disable-dev-shm-usage','--lang=es-ES,es']
            });
            const page = await browser.newPage();
            await page.setViewport({ width: 1600, height: 1200, deviceScaleFactor: 2 });
            await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0 Safari/537.36');

            const url = 'https://finviz.com/map.ashx?t=sec&st=d1';
            let ready=false, tries=0;
            while(!ready && tries<3){
              tries++;
              await page.goto(url, { waitUntil: 'domcontentloaded', timeout: 60000 }).catch(()=>{});
              await page.evaluate(()=>{
                const b=[...document.querySelectorAll('button,a')].find(x=>/accept|agree|consent|aceptar/i.test((x.innerText||'')+''));
                b?.click();
              }).catch(()=>{});
              ready = await waitForCanvasReady(page, 70000);
              if(!ready) await sleep(2000);
            }

            const clip = await page.evaluate(() => {
              const cs = Array.from(document.querySelectorAll('canvas'));
              const big = cs.map(c=>{
                const r=c.getBoundingClientRect();
                return {x:Math.max(0,r.x),y:Math.max(0,r.y),w:r.width,h:r.height,area:r.width*r.height};
              }).filter(b=>b.area>120000);
              if(!big.length) return null;
              const x0=Math.floor(Math.min(...big.map(b=>b.x)));
              const y0=Math.floor(Math.min(...big.map(b=>b.y)))-60;
              const x1=Math.ceil(Math.max(...big.map(b=>b.x+b.w)));
              const y1=Math.ceil(Math.max(...big.map(b=>b.y+b.h)))+40;
              return {x:Math.max(0,x0), y:Math.max(0,y0), width:x1-x0, height:y1-y0};
            });

            if(clip && clip.width>0 && clip.height>0) {
              await page.screenshot({ path: 'heatmap.png', clip });
            } else {
              await page.screenshot({ path: 'heatmap.png', fullPage: true });
            }
            await browser.close();
          })().catch(e=>{console.error(e); process.exit(0);});
          EOF

      - name: Run screenshot
        run: node screenshot.js

      # ---------- Resumen + Opini√≥n ‚Üí summary.json ----------
      - name: Build summary script (JSON output)
        run: |
          cat > summary.js <<'EOF'
          const puppeteer = require('puppeteer');
          const fs = require('fs');

          const UA='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0 Safari/537.36';
          const REF='https://finviz.com/';
          const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
          async function retry(n, fn){ let last; for(let i=0;i<n;i++){ try{ return await fn(); } catch(e){ last=e; await sleep(700);} } throw last||new Error('retry failed'); }
          async function acceptConsent(page){
            try{
              await page.evaluate(()=>{
                const btn=[...document.querySelectorAll('button,a')].find(x=>/accept|agree|consent|aceptar/i.test((x?.innerText||'')));
                btn?.click();
              });
            }catch(_){}
          }

          // ---------- √çndices robustos (Stooq) ----------
          async function stooqPct(symbol){
            const urlDaily=`https://stooq.com/q/d/l/?s=${symbol}&i=d`;
            const res = await fetch(urlDaily);
            if(!res.ok) throw new Error('stooq fail');
            const txt = await res.text();
            const lines = txt.trim().split('\n');
            if(lines.length<3) throw new Error('not enough rows');
            const [prev, close] = lines.slice(-2).map(l=>parseFloat(l.split(',')[4]));
            if(!prev || !close) throw new Error('parse');
            return ((close-prev)/prev)*100;
          }

          // ---------- SECTORES (Groups) ----------
          async function grabSectors(page){
            const url='https://finviz.com/groups.ashx?g=sector&v=210';
            await page.goto(url, {waitUntil:'domcontentloaded', timeout:60000});
            await acceptConsent(page);
            await page.waitForSelector('table.table-light', {timeout:20000});
            return await page.$$eval('table.table-light tr', rows => {
              const out=[];
              for(const r of rows.slice(1)){
                const tds=[...r.querySelectorAll('td')].map(td=>td.innerText.trim());
                const name = tds[1];
                const today = (tds[2]||'').replace(',','.');
                const pct = parseFloat(today.replace('%',''));
                if(name) out.push({name, pct: isNaN(pct)?0:pct});
              }
              const top = [...out].sort((a,b)=>b.pct-a.pct).slice(0,2);
              const worst = [...out].sort((a,b)=>a.pct-b.pct).slice(0,2);
              return {top, worst};
            });
          }

          // ---------- MOVERS SP500 (Screener) ----------
          async function grabMovers(page, order){
            const o = order==='desc' ? '-change' : 'change';
            const url = `https://finviz.com/screener.ashx?v=111&f=idx_sp500&o=${o}`;
            await page.goto(url, {waitUntil:'domcontentloaded', timeout:60000});
            await acceptConsent(page);
            await page.waitForSelector('table.table-light', {timeout:20000});
            return await page.$$eval('table.table-light tr', rows => {
              const out=[];
              for(const r of rows.slice(1)){
                const ticker = r.querySelector('a.screener-link-primary')?.innerText?.trim() || '';
                const tds=[...r.querySelectorAll('td')].map(td=>td.innerText.trim());
                const perc = (tds.reverse().find(x=>/%$/.test(x)) || '').replace(/\s+/g,'');
                if(ticker && perc) out.push({t:ticker, ch:perc});
                if(out.length===3) break;
              }
              return out;
            });
          }

          // ---------- Titular (opcional) ----------
          async function grabHeadline(page){
            const url = 'https://finviz.com/news.ashx';
            await page.goto(url, {waitUntil:'domcontentloaded', timeout:60000});
            await acceptConsent(page);
            const ok = await page.$('.news-item-row');
            if(!ok) return '';
            return await page.evaluate(() => {
              const row = document.querySelector('.news-item-row');
              const a = row?.querySelector('a');
              const src = row?.querySelector('.news-source')?.innerText || '';
              return a ? `${a.innerText} ‚Äî ${src}` : '';
            });
          }

          (async () => {
            const browser = await puppeteer.launch({ headless:'new', args:['--no-sandbox','--disable-setuid-sandbox'] });
            const page = await browser.newPage();
            await page.setUserAgent(UA);
            await page.setExtraHTTPHeaders({ 'Referer': REF, 'Accept-Language': 'es-ES,es;q=0.9,en;q=0.8' });
            await page.setViewport({ width: 1366, height: 900, deviceScaleFactor: 1 });

            // √çndices (ETFs) desde Stooq
            const [sp,nq,dj] = await Promise.all([
              retry(3, ()=>stooqPct('spy.us')),
              retry(3, ()=>stooqPct('qqq.us')),
              retry(3, ()=>stooqPct('dia.us'))
            ]).catch(()=>[null,null,null]);

            let sectors=null, winners=[], losers=[], headline='';
            try { sectors = await retry(3, ()=>grabSectors(page)); } catch(e) { sectors=null; }
            try { winners = await retry(3, ()=>grabMovers(page,'desc')); } catch(e) { winners=[]; }
            try { losers  = await retry(3, ()=>grabMovers(page,'asc'));  } catch(e) { losers=[]; }
            try { headline = await retry(2, ()=>grabHeadline(page));     } catch(e) { headline=''; }

            await browser.close();

            // ---------- Opini√≥n enriquecida (siempre no vac√≠a) ----------
            function val(x){ return (typeof x === 'number') ? x : 0; }
            function avg(...xs){ return xs.map(val).reduce((a,b)=>a+b,0)/xs.length; }
            const m = { up: 0.35, down: -0.35 };
            const spv = val(sp), nqv = val(nq), djv = val(dj);
            const meanIdx = avg(spv, nqv, djv);

            const topNames   = (sectors?.top   || []).map(s=>s.name);
            const worstNames = (sectors?.worst || []).map(s=>s.name);

            const growthHit  = worstNames.some(n=>/Technology|Communication Services/i.test(n));
            const growthLead = topNames.some(n=>/Technology|Communication Services|Consumer Cyclical/i.test(n));
            const defensives = topNames.some(n=>/Utilities|Consumer Defensive|Healthcare/i.test(n));

            let opinion = '';
            if (meanIdx <= m.down && growthHit) {
              opinion = 'Sesgo <b>risk-off</b>: presi√≥n en growth (Tech/Comms) y rotaci√≥n a defensivas.';
            } else if (meanIdx >= m.up && growthLead) {
              opinion = 'Tono <b>risk-on</b>: rebote liderado por growth (Tech/Discrecional).';
            } else if (defensives && meanIdx < 0.15) {
              opinion = 'Defensivas toman el relevo; cautela con momentum de corto plazo.';
            } else if (Math.abs(meanIdx) < 0.15) {
              opinion = 'Sesi√≥n mixta, sin direcci√≥n clara; foco en catalizadores puntuales.';
            } else {
              opinion = meanIdx > 0 ? 'Cierre positivo con amplitud moderada.' : 'Cierre en rojo, pero sin capitulaci√≥n.';
            }
            const add=[];
            if (sectors?.top?.length)   add.push(`mejor: ${sectors.top[0].name}`);
            if (sectors?.worst?.length) add.push(`peor: ${sectors.worst[0].name}`);
            if (add.length) opinion += ` (${add.join(' ¬∑ ')})`;

            // ---------- Payload ----------
            const d = new Date().toLocaleDateString('es-ES',{timeZone:'Europe/Madrid'});
            const fmt = v => (typeof v === 'number') ? `${v.toFixed(2)}%` : '‚Äî';
            const secStr = arr => (arr||[]).map(s=>`${s.name} ${s.pct.toFixed(2)}%`).join(', ') || '‚Äî';
            const movStr = arr => (arr||[]).map(x=>`${x.t} ${x.ch}`).join(', ') || '‚Äî';

            const payload = {
              date: d,
              sp: fmt(sp), nq: fmt(nq), dj: fmt(dj),
              secBest: secStr(sectors?.top),
              secWorst: secStr(sectors?.worst),
              winners: movStr(winners),
              losers: movStr(losers),
              headline: headline || '',
              opinion: opinion || 'Sesi√≥n mixta.'
            };
            fs.writeFileSync('summary.json', JSON.stringify(payload), 'utf8');
          })();
          EOF

      - name: Run summary (creates summary.json)
        run: node summary.js

      # ---------- Construir caption (HTML seguro) ----------
      - name: Build caption.txt
        run: |
          DATE=$(jq -r '.date' summary.json)
          SP=$(jq -r '.sp' summary.json)
          NQ=$(jq -r '.nq' summary.json)
          DJ=$(jq -r '.dj' summary.json)
          SEC_BEST=$(jq -r '.secBest' summary.json)
          SEC_WORST=$(jq -r '.secWorst' summary.json)
          WINNERS=$(jq -r '.winners' summary.json)
          LOSERS=$(jq -r '.losers' summary.json)
          OPINION=$(jq -r '.opinion' summary.json)
          HEADLINE=$(jq -r '.headline' summary.json)

          esc() { sed 's/&/&amp;/g; s/</\&lt;/g; s/>/\&gt;/g'; }

          {
            echo "<b>üìä Cierre de mercado ‚Äî ${DATE}</b>"
            echo "‚Ä¢ S&amp;P500: ${SP} | Nasdaq: ${NQ} | Dow: ${DJ}"
            echo "‚Ä¢ <b>Sectores destacados:</b> $(printf '%s' "${SEC_BEST}" | esc)"
            echo "‚Ä¢ <b>Peores sectores:</b> $(printf '%s' "${SEC_WORST}" | esc)"
            echo "‚Ä¢ <b>Top ganadores (S&amp;P500):</b> $(printf '%s' "${WINNERS}" | esc)"
            echo "‚Ä¢ <b>Top perdedores (S&amp;P500):</b> $(printf '%s' "${LOSERS}" | esc)"
            echo ""
            echo "üí° <i>Opini√≥n:</i> $(printf '%s' "${OPINION}" | esc)"
            if [ -n "${HEADLINE}" ] && [ "${HEADLINE}" != "null" ]; then
              echo "üóûÔ∏è $(printf '%s' "${HEADLINE}" | esc)"
            fi
          } > caption.txt

      # ---------- Enviar a Telegram ----------
      - name: Send to Telegram
        env:
          BOT_TOKEN: ${{ secrets.INVESTX_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          python3 - <<'PY'
          import os, requests
          bot = os.environ['BOT_TOKEN']
          chat = os.environ['CHAT_ID']
          with open("caption.txt","r", encoding="utf-8") as f: caption=f.read()
          with open("heatmap.png","rb") as f:
              r = requests.post(
                  f"https://api.telegram.org/bot{bot}/sendPhoto",
                  data={"chat_id": chat, "caption": caption, "parse_mode":"HTML"},
                  files={"photo": ("heatmap.png", f, "image/png")},
                  timeout=120
              )
              print(r.status_code, r.text)
              r.raise_for_status()
          PY
