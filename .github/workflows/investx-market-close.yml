name: InvestX Market Close

on:
  schedule:
    - cron: "0 21 * * 1-5"   # 23:00 Madrid (21:00 UTC), L‚ÄìV
  workflow_dispatch:

jobs:
  market-close:
    runs-on: ubuntu-22.04

    steps:
      # ---------- Dependencias del sistema ----------
      - name: Install system deps
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y \
            jq curl unzip python3 python3-pip \
            libatk1.0-0 libatk-bridge2.0-0 libnss3 libx11-6 libx11-xcb1 \
            libxcomposite1 libxdamage1 libxext6 libxfixes3 libxrandr2 \
            libgbm1 libasound2 fonts-liberation

      # ---------- Node / Puppeteer ----------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer
        run: npm i puppeteer@22

      # ---------- Captura del heatmap ----------
      - name: Build screenshot script
        run: |
          cat > screenshot.js <<'EOF'
          const puppeteer = require('puppeteer');
          const sleep = ms => new Promise(r=>setTimeout(r,ms));

          async function waitForCanvasReady(page, timeoutMs=70000) {
            const t0 = Date.now();
            while (Date.now()-t0 < timeoutMs) {
              const ok = await page.evaluate(() => {
                const cs = Array.from(document.querySelectorAll('canvas'));
                if (!cs.length) return false;
                const big = cs.map(c=>({w:c.width,h:c.height,bb:c.getBoundingClientRect()}))
                              .sort((a,b)=>b.w*b.h-a.w*a.h)[0];
                return big && big.w>=800 && big.h>=500;
              });
              if (ok) return true;
              await sleep(500);
            }
            return false;
          }

          (async () => {
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox','--disable-setuid-sandbox','--disable-dev-shm-usage','--lang=es-ES,es']
            });
            const page = await browser.newPage();
            await page.setViewport({ width: 1600, height: 1200, deviceScaleFactor: 2 });
            await page.setUserAgent('Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124 Safari/537.36');

            const url = 'https://finviz.com/map.ashx?t=sec&st=d1';
            let ready=false, tries=0;
            while(!ready && tries<3){
              tries++;
              await page.goto(url, { waitUntil: 'domcontentloaded', timeout: 60000 }).catch(()=>{});
              await page.evaluate(()=>{
                const b=[...document.querySelectorAll('button,a')].find(x=>/accept|agree|consent|aceptar/i.test((x.innerText||'')+''));
                b?.click();
              }).catch(()=>{});
              ready = await waitForCanvasReady(page, 70000);
              if(!ready) await sleep(2000);
            }

            const clip = await page.evaluate(() => {
              const cs = Array.from(document.querySelectorAll('canvas'));
              const big = cs.map(c=>{
                const r=c.getBoundingClientRect();
                return {x:Math.max(0,r.x),y:Math.max(0,r.y),w:r.width,h:r.height,area:r.width*r.height};
              }).filter(b=>b.area>120000);
              if(!big.length) return null;
              const x0=Math.floor(Math.min(...big.map(b=>b.x)));
              const y0=Math.floor(Math.min(...big.map(b=>b.y)))-60;
              const x1=Math.ceil(Math.max(...big.map(b=>b.x+b.w)));
              const y1=Math.ceil(Math.max(...big.map(b=>b.y+b.h)))+40;
              return {x:Math.max(0,x0), y:Math.max(0,y0), width:x1-x0, height:y1-y0};
            });

            if(clip && clip.width>0 && clip.height>0) {
              await page.screenshot({ path: 'heatmap.png', clip });
            } else {
              await page.screenshot({ path: 'heatmap.png', fullPage: true });
            }
            await browser.close();
          })().catch(e=>{console.error(e); process.exit(0);});
          EOF

      - name: Run screenshot
        run: node screenshot.js

      # ---------- Resumen + Opini√≥n ----------
      - name: Build summary script
        run: |
          cat > summary.js <<'EOF'
          const puppeteer = require('puppeteer');
          const fs = require('fs');

          async function grabChange(page, ticker){
            const url=`https://finviz.com/quote.ashx?t=${ticker}`;
            await page.goto(url, {waitUntil:'domcontentloaded', timeout:60000}).catch(()=>{});
            const text = await page.evaluate(() => document.body.innerText).catch(()=> '');
            const m = text.match(/-?\d+(?:\.\d+)?%/);
            return m ? parseFloat(m[0].replace('%','')) : null;
          }

          async function grabSectors(page){
            const url='https://finviz.com/groups.ashx?g=sector&v=210';
            await page.goto(url, {waitUntil:'domcontentloaded', timeout:60000}).catch(()=>{});
            return await page.evaluate(() => {
              const rows = [...document.querySelectorAll('table.table-light tr')].slice(1);
              const data = rows.map(r=>{
                const tds=[...r.querySelectorAll('td')].map(td=>td.innerText.trim());
                return {name: tds[1], pct: parseFloat((tds[2]||'0').replace('%',''))};
              }).filter(x=>x.name);
              const top = [...data].sort((a,b)=>b.pct-a.pct).slice(0,2);
              const worst = [...data].sort((a,b)=>a.pct-b.pct).slice(0,2);
              return {top, worst};
            });
          }

          async function grabMovers(page, order){
            const o = order==='desc' ? '-change' : 'change';
            const url = `https://finviz.com/screener.ashx?v=111&f=idx_sp500&o=${o}`;
            await page.goto(url, {waitUntil:'domcontentloaded', timeout:60000}).catch(()=>{});
            return await page.evaluate(() => {
              const rows = [...document.querySelectorAll('table.table-light tr')].slice(1,6);
              return rows.map(r=>{
                const tds=[...r.querySelectorAll('td')].map(td=>td.innerText.trim());
                return {t: tds[1], ch: tds[8]};
              }).slice(0,3);
            });
          }

          async function grabNews(page){
            const url = 'https://finviz.com/news.ashx';
            await page.goto(url, {waitUntil:'domcontentloaded', timeout:60000}).catch(()=>{});
            return await page.evaluate(() => {
              const row = document.querySelector('.news-item-row');
              if(!row) return null;
              const a = row.querySelector('a');
              const src = row.querySelector('.news-source')?.innerText || '';
              return a ? `${a.innerText} ‚Äî ${src}` : null;
            });
          }

          (async () => {
            const browser = await puppeteer.launch({ headless:'new', args:['--no-sandbox','--disable-setuid-sandbox'] });
            const page = await browser.newPage();

            const [sp,nq,dj] = await Promise.all([
              grabChange(page,'SPY'),
              grabChange(page,'QQQ'),
              grabChange(page,'DIA')
            ]);

            const sectors = await grabSectors(page).catch(()=>null);
            const winners = await grabMovers(page,'desc').catch(()=>[]);
            const losers  = await grabMovers(page,'asc').catch(()=>[]);
            const headline = await grabNews(page).catch(()=>null);

            await browser.close();

            let opinion = 'Sesi√≥n mixta.';
            if([sp,nq,dj].every(x=>x<0)) opinion='Sesgo risk-off, todos en rojo.';
            else if(sectors?.worst?.some(s=>/tech/i.test(s.name))) opinion='Debilidad en tecnolog√≠a, rotaci√≥n defensiva.';
            else if((sp??0)>0 && (nq??0)>0) opinion='Impulso alcista liderado por growth.';
            
            const d = new Date().toLocaleDateString('es-ES',{timeZone:'Europe/Madrid'});

            const caption = `
üìä **Cierre de mercado ‚Äî ${d}**
${idxLine}
‚Ä¢ Sectores destacados: ${sectors?.top?.map(s=>s.name+' '+s.pct+'%').join(', ') || '‚Äî'}
‚Ä¢ Peores sectores: ${sectors?.worst?.map(s=>s.name+' '+s.pct+'%').join(', ') || '‚Äî'}
‚Ä¢ Top ganadores (S&P500): ${winners.map(x=>x.t+' '+x.ch).join(', ') || '‚Äî'}
‚Ä¢ Top perdedores (S&P500): ${losers.map(x=>x.t+' '+x.ch).join(', ') || '‚Äî'}

üí° *Opini√≥n*: ${opinion}
${headline ? 'üóûÔ∏è Noticia: '+headline : ''}
`.trim();

            require('fs').writeFileSync('caption.txt', caption, 'utf8');


      - name: Run summary
        run: node summary.js

      # ---------- Enviar a Telegram ----------
      - name: Send to Telegram
        env:
          BOT_TOKEN: ${{ secrets.INVESTX_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          python3 - <<'PY'
          import os, requests
          bot = os.environ['BOT_TOKEN']
          chat = os.environ['CHAT_ID']
          with open("caption.txt","r") as f: caption=f.read()
          with open("heatmap.png","rb") as f:
              r = requests.post(
                  f"https://api.telegram.org/bot{bot}/sendPhoto",
                  data={"chat_id": chat, "caption": caption, "parse_mode":"Markdown"},
                  files={"photo": ("heatmap.png", f, "image/png")},
                  timeout=120
              )
              print(r.status_code, r.text)
              r.raise_for_status()
          PY
