name: InvestX Market Close

on:
  schedule:
    - cron: "0 21 * * 1-5"   # 23:00 Madrid (21:00 UTC), Lâ€“V
  workflow_dispatch:

jobs:
  market-close:
    runs-on: ubuntu-22.04

    steps:
      # ---------- Dependencias del sistema ----------
      - name: Install system deps
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y \
            jq curl unzip python3 python3-pip \
            libatk1.0-0 libatk-bridge2.0-0 libnss3 libx11-6 libx11-xcb1 \
            libxcomposite1 libxdamage1 libxext6 libxfixes3 libxrandr2 \
            libgbm1 libasound2 fonts-liberation ca-certificates
          curl -sL https://github.com/ericchiang/pup/releases/download/v0.4.0/pup_v0.4.0_linux_amd64.zip -o pup.zip
          unzip -o pup.zip -d /usr/local/bin
          chmod +x /usr/local/bin/pup

      # ---------- Node / Puppeteer ----------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer
        run: npm i puppeteer@22

      # ---------- Captura del heatmap ----------
      - name: Build screenshot script
        run: |
          cat > screenshot.js <<'EOF'
          const puppeteer = require('puppeteer');
          const sleep = ms => new Promise(r=>setTimeout(r,ms));

          async function waitForCanvasReady(page, timeoutMs=70000) {
            const t0 = Date.now();
            while (Date.now()-t0 < timeoutMs) {
              const ok = await page.evaluate(() => {
                const cs = Array.from(document.querySelectorAll('canvas'));
                if (!cs.length) return false;
                const big = cs.map(c=>({w:c.width,h:c.height,bb:c.getBoundingClientRect()}))
                              .sort((a,b)=>b.w*b.h-a.w*a.h)[0];
                return big && big.w>=800 && big.h>=500;
              });
              if (ok) return true;
              await sleep(500);
            }
            return false;
          }

          (async () => {
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox','--disable-setuid-sandbox','--disable-dev-shm-usage','--lang=es-ES,es']
            });
            const page = await browser.newPage();
            await page.setViewport({ width: 1600, height: 1200, deviceScaleFactor: 2 });
            await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124 Safari/537.36');

            const url = 'https://finviz.com/map.ashx?t=sec&st=d1';
            let ready=false, tries=0;
            while(!ready && tries<3){
              tries++;
              await page.goto(url, { waitUntil: 'domcontentloaded', timeout: 60000 }).catch(()=>{});
              await page.evaluate(()=>{
                const b=[...document.querySelectorAll('button,a')].find(x=>/accept|agree|consent|aceptar/i.test((x.innerText||'')));
                b?.click();
              }).catch(()=>{});
              ready = await waitForCanvasReady(page, 70000);
              if(!ready) await sleep(2000);
            }

            const clip = await page.evaluate(() => {
              const cs = Array.from(document.querySelectorAll('canvas'));
              const big = cs.map(c=>{
                const r=c.getBoundingClientRect();
                return {x:Math.max(0,r.x),y:Math.max(0,r.y),w:r.width,h:r.height,area:r.width*r.height};
              }).filter(b=>b.area>120000);
              if(!big.length) return null;
              const x0=Math.floor(Math.min(...big.map(b=>b.x)));
              const y0=Math.floor(Math.min(...big.map(b=>b.y)))-60;
              const x1=Math.ceil(Math.max(...big.map(b=>b.x+b.w)));
              const y1=Math.ceil(Math.max(...big.map(b=>b.y+b.h)))+40;
              return {x:Math.max(0,x0), y:Math.max(0,y0), width:x1-x0, height:y1-y0};
            });

            if(clip && clip.width>0 && clip.height>0) {
              await page.screenshot({ path: 'heatmap.png', clip });
            } else {
              await page.screenshot({ path: 'heatmap.png', fullPage: true });
            }
            await browser.close();
          })().catch(e=>{console.error(e); process.exit(0);});
          EOF

      - name: Run screenshot
        run: node screenshot.js

      # ---------- Resumen + OpiniÃ³n analista (6-10 lÃ­neas) ----------
      - name: Build summary (summary.json)
        run: |
          set -e
          cat > summary.js <<'JS'
          const fs = require('fs');
          const fetchTxt = async url => (await fetch(url)).text();

          // ===== Utilidades Stooq =====
          async function stooqPct(symbol){
            const url=`https://stooq.com/q/d/l/?s=${symbol}&i=d`;
            const txt = await fetchTxt(url);
            const lines = txt.trim().split('\n');
            const [prev, close] = lines.slice(-2).map(l=>parseFloat(l.split(',')[4]));
            if(!prev || !close) throw new Error('stooq parse');
            return ((close-prev)/prev)*100;
          }
          const sign = n => `${n>=0?'+':''}${n.toFixed(2)}%`;

          // Sectores vÃ­a ETFs (estable)
          const sectorETFs = [
            {name:'Technology', sym:'xlk.us'},
            {name:'Communication Services', sym:'xlc.us'},
            {name:'Consumer Cyclical', sym:'xly.us'},
            {name:'Consumer Defensive', sym:'xlp.us'},
            {name:'Financial', sym:'xlf.us'},
            {name:'Healthcare', sym:'xlv.us'},
            {name:'Industrials', sym:'xli.us'},
            {name:'Energy', sym:'xle.us'},
            {name:'Materials', sym:'xlb.us'},
            {name:'Real Estate', sym:'xlre.us'},
            {name:'Utilities', sym:'xlu.us'},
          ];
          async function sectorsTodayFull(){
            const vals = await Promise.allSettled(sectorETFs.map(async s=>{
              const pct = await stooqPct(s.sym); return {name:s.name, pct};
            }));
            const all = vals.filter(v=>v.status==='fulfilled').map(v=>v.value);
            const top=[...all].sort((a,b)=>b.pct-a.pct).slice(0,3);
            const low=[...all].sort((a,b)=>a.pct-b.pct).slice(0,3);
            const pos=all.filter(x=>x.pct>=0).length, neg=all.length-pos;
            return {all, top, low, pos, neg};
          }

          // Mega-caps para ganadores/perdedores (si Finviz falla)
          const heavySPX = ['AAPL','MSFT','NVDA','AMZN','GOOGL','META','AVGO','BRK-B','TSLA','XOM','LLY','JPM','UNH','V','JNJ','GOOG','PG','MA','HD','COST','ABBV','BAC','WMT','CVX','MRK','PEP','KO','NFLX','ADBE','CRM'];
          const mapStooq = t => `${t.toLowerCase()}.us`.replace('brk-b','brk-b');
          async function moversToday(){
            const vals = await Promise.allSettled(heavySPX.map(async t=>{
              const pct = await stooqPct(mapStooq(t)); return {t, pct};
            }));
            const arr = vals.filter(v=>v.status==='fulfilled').map(v=>v.value);
            const gain = [...arr].sort((a,b)=>b.pct-a.pct).slice(0,3);
            const loss = [...arr].sort((a,b)=>a.pct-b.pct).slice(0,3);
            return {gain, loss};
          }

          // Titular (Reuters) para contexto
          function clean(s){ return (s||'').replace(/&amp;/g,'&').replace(/\s+/g,' ').trim(); }
          async function headline(){
            try{
              const rss = await fetchTxt('https://feeds.reuters.com/reuters/businessNews');
              const title = clean((rss.match(/<title>([^<]+)<\/title>/i)||[])[1]);
              if(title) return `${title} â€” Reuters`;
            }catch(_){}
            return '';
          }

          // OpiniÃ³n analista (6â€“10 lÃ­neas)
          function analystOpinion(sp,nq,dj,sectors,head,movers){
            const v = x => typeof x==='number' ? x : 0;
            const mean = (v(sp)+v(nq)+v(dj))/3;
            const dir = mean>0 ? 'al alza' : mean<0 ? 'a la baja' : 'mixto';
            const best = sectors.top?.[0], worst = sectors.low?.[0];
            const gain1 = movers.gain?.[0], loss1 = movers.loss?.[0];
            const lines = [];

            lines.push(`Los Ã­ndices estadounidenses cerraron ${dir}: S&P500 ${sign(v(sp))}, Nasdaq ${sign(v(nq))} y Dow ${sign(v(dj))}.`);
            if (best && worst) {
              lines.push(`Por sectores, destacÃ³ ${best.name} (${sign(best.pct)}), mientras ${worst.name} quedÃ³ rezagado (${sign(worst.pct)}).`);
            }
            lines.push(`La amplitud sectorial quedÃ³ en ${sectors.pos}/${sectors.pos+sectors.neg} en positivo, lo que sugiere ${sectors.pos >= 7 ? 'acompaÃ±amiento amplio' : sectors.pos <= 4 ? 'avance selectivo' : 'participaciÃ³n moderada'}.`);

            if (gain1 && loss1) {
              lines.push(`Entre mega-caps, sobresaliÃ³ ${gain1.t} (${sign(gain1.pct)}), en contraste con ${loss1.t} (${sign(loss1.pct)}).`);
            }

            // Detecta foco: growth vs defensivas
            const growthLead = /Technology|Communication Services|Consumer Cyclical/.test(best?.name||'');
            const defensivesLead = /Utilities|Consumer Defensive|Healthcare/.test(best?.name||'');
            if (growthLead) lines.push('Se observÃ³ sesgo hacia â€œgrowthâ€ y beta alta, con mejor comportamiento relativo frente a defensivas.');
            else if (defensivesLead) lines.push('El flujo favoreciÃ³ a perfiles defensivos, con mejor comportamiento relativo frente a growth.');

            // Titular contextual
            if (head) {
              const h = head.toLowerCase();
              const cause =
                /cpi|inflation|pce|ipc/.test(h) ? 'tras referencias de inflaciÃ³n' :
                /fed|rate|yield|tipos|powell|hike|cut/.test(h) ? 'por expectativas de tipos y rendimientos' :
                /jobs|payrolls|paro|employment/.test(h) ? 'despuÃ©s de datos laborales' :
                /earnings|results|guidance|beneficios|ingresos/.test(h) ? 'apoyado por resultados empresariales' :
                /china|tariff|geopol/.test(h) ? 'con ruido geopolÃ­tico en el fondo' :
                'con flujo de titulares mixto';
              lines.push(`El movimiento se interpretÃ³ ${cause}: ${head}.`);
            }

            // Pildorita operativa
            if (mean > 0.3) lines.push('Para maÃ±ana, vigilar continuidad del impulso y posibles tomas de beneficio en lÃ­deres.');
            else if (mean < -0.3) lines.push('Para maÃ±ana, atentos a rebotes tÃ©cnicos y a soportes recientes en tecnolÃ³gicas.');
            else lines.push('De cara a maÃ±ana, clave la rotaciÃ³n y el comportamiento de lÃ­deres frente al mercado.');

            return lines.slice(0,10).join('\n');
          }

          (async () => {
            // Ãndices (ETFs representativos)
            let sp=null,nq=null,dj=null;
            try { [sp,nq,dj] = await Promise.all([stooqPct('spy.us'), stooqPct('qqq.us'), stooqPct('dia.us')]); } catch(_){}

            const sectors = await sectorsTodayFull();
            const movers  = await moversToday();
            const head    = await headline();

            const d = new Date().toLocaleDateString('es-ES',{timeZone:'Europe/Madrid'});
            const secStr = a => (a||[]).map(x=>`${x.name} ${sign(x.pct)}`).join(', ') || 'â€”';
            const movStr = a => (a||[]).map(x=>`${x.t} ${sign(x.pct)}`).join(', ') || 'â€”';

            const payload = {
              date: d,
              sp: typeof sp==='number'?sign(sp):'â€”',
              nq: typeof nq==='number'?sign(nq):'â€”',
              dj: typeof dj==='number'?sign(dj):'â€”',
              secBest: secStr(sectors.top),
              secWorst: secStr(sectors.low),
              winners: movStr(movers.gain),
              losers:  movStr(movers.loss),
              headline: head,
              opinion: analystOpinion(sp,nq,dj,sectors,head,movers)
            };
            fs.writeFileSync('summary.json', JSON.stringify(payload), 'utf8');
          })();
          JS
          node summary.js

      # ---------- Construir caption ----------
      - name: Build caption.txt
        run: |
          DATE=$(jq -r '.date' summary.json)
          SP=$(jq -r '.sp' summary.json)
          NQ=$(jq -r '.nq' summary.json)
          DJ=$(jq -r '.dj' summary.json)
          SEC_BEST=$(jq -r '.secBest' summary.json)
          SEC_WORST=$(jq -r '.secWorst' summary.json)
          WINNERS=$(jq -r '.winners' summary.json)
          LOSERS=$(jq -r '.losers' summary.json)
          OPINION=$(jq -r '.opinion' summary.json)
          HEADLINE=$(jq -r '.headline' summary.json)

          {
            echo "<b>ðŸ“Š Cierre de mercado â€” ${DATE}</b>"
            echo "â€¢ S&amp;P500: ${SP} | Nasdaq: ${NQ} | Dow: ${DJ}"
            echo "â€¢ <b>Sectores destacados:</b> ${SEC_BEST}"
            echo "â€¢ <b>Peores sectores:</b> ${SEC_WORST}"
            echo "â€¢ <b>Top ganadores (S&amp;P500):</b> ${WINNERS}"
            echo "â€¢ <b>Top perdedores (S&amp;P500):</b> ${LOSERS}"
            echo ""
            # OpiniÃ³n multilÃ­nea (texto plano)
            echo "ðŸ’¡ <i>OpiniÃ³n:</i>"
            echo "$(printf '%s' "${OPINION}")"
            if [ -n "${HEADLINE}" ] && [ "${HEADLINE}" != "null" ]; then
              echo ""
              echo "ðŸ—žï¸ ${HEADLINE}"
            fi
          } > caption.txt

      # ---------- Enviar a Telegram ----------
      - name: Send to Telegram
        env:
          BOT_TOKEN: ${{ secrets.INVESTX_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          python3 - <<'PY'
          import os, requests
          bot = os.environ['BOT_TOKEN']
          chat = os.environ['CHAT_ID']
          with open("caption.txt","r", encoding="utf-8") as f: caption=f.read()
          with open("heatmap.png","rb") as f:
              r = requests.post(
                  f"https://api.telegram.org/bot{bot}/sendPhoto",
                  data={"chat_id": chat, "caption": caption, "parse_mode":"HTML"},
                  files={"photo": ("heatmap.png", f, "image/png")},
                  timeout=120
              )
              print(r.status_code, r.text)
              r.raise_for_status()
          PY
