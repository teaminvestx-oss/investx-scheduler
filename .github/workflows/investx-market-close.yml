name: InvestX Market Close

on:
  schedule:
    - cron: "0 21 * * 1-5"   # 23:00 Madrid (21:00 UTC), Lâ€“V
  workflow_dispatch:

jobs:
  market-close:
    runs-on: ubuntu-22.04

    steps:
      # ---------- Dependencias del sistema ----------
      - name: Install system deps
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y \
            jq curl unzip python3 python3-pip \
            libatk1.0-0 libatk-bridge2.0-0 libnss3 libx11-6 libx11-xcb1 \
            libxcomposite1 libxdamage1 libxext6 libxfixes3 libxrandr2 \
            libgbm1 libasound2 fonts-liberation ca-certificates
          curl -sL https://github.com/ericchiang/pup/releases/download/v0.4.0/pup_v0.4.0_linux_amd64.zip -o pup.zip
          unzip -o pup.zip -d /usr/local/bin
          chmod +x /usr/local/bin/pup

      # ---------- Node / Puppeteer ----------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer
        run: npm i puppeteer@22

      # ---------- Captura del heatmap ----------
      - name: Build screenshot script
        run: |
          cat > screenshot.js <<'EOF'
          const puppeteer = require('puppeteer');
          const sleep = ms => new Promise(r=>setTimeout(r,ms));

          async function waitForCanvasReady(page, timeoutMs=70000) {
            const t0 = Date.now();
            while (Date.now()-t0 < timeoutMs) {
              const ok = await page.evaluate(() => {
                const cs = Array.from(document.querySelectorAll('canvas'));
                if (!cs.length) return false;
                const big = cs.map(c=>({w:c.width,h:c.height,bb:c.getBoundingClientRect()}))
                              .sort((a,b)=>b.w*b.h-a.w*a.h)[0];
                return big && big.w>=800 && big.h>=500;
              });
              if (ok) return true;
              await sleep(500);
            }
            return false;
          }

          (async () => {
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox','--disable-setuid-sandbox','--disable-dev-shm-usage','--lang=es-ES,es']
            });
            const page = await browser.newPage();
            await page.setViewport({ width: 1600, height: 1200, deviceScaleFactor: 2 });
            await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124 Safari/537.36');

            const url = 'https://finviz.com/map.ashx?t=sec&st=d1';
            let ready=false, tries=0;
            while(!ready && tries<3){
              tries++;
              await page.goto(url, { waitUntil: 'domcontentloaded', timeout: 60000 }).catch(()=>{});
              await page.evaluate(()=>{
                const b=[...document.querySelectorAll('button,a')].find(x=>/accept|agree|consent|aceptar/i.test((x.innerText||'')+''));
                b?.click();
              }).catch(()=>{});
              ready = await waitForCanvasReady(page, 70000);
              if(!ready) await sleep(2000);
            }

            const clip = await page.evaluate(() => {
              const cs = Array.from(document.querySelectorAll('canvas'));
              const big = cs.map(c=>{
                const r=c.getBoundingClientRect();
                return {x:Math.max(0,r.x),y:Math.max(0,r.y),w:r.width,h:r.height,area:r.width*r.height};
              }).filter(b=>b.area>120000);
              if(!big.length) return null;
              const x0=Math.floor(Math.min(...big.map(b=>b.x)));
              const y0=Math.floor(Math.min(...big.map(b=>b.y)))-60;
              const x1=Math.ceil(Math.max(...big.map(b=>b.x+b.w)));
              const y1=Math.ceil(Math.max(...big.map(b=>b.y+b.h)))+40;
              return {x:Math.max(0,x0), y:Math.max(0,y0), width:x1-x0, height:y1-y0};
            });

            if(clip && clip.width>0 && clip.height>0) {
              await page.screenshot({ path: 'heatmap.png', clip });
            } else {
              await page.screenshot({ path: 'heatmap.png', fullPage: true });
            }
            await browser.close();
          })().catch(e=>{console.error(e); process.exit(0);});
          EOF

      - name: Run screenshot
        run: node screenshot.js

      # ---------- Resumen + OpiniÃ³n (curl+pup+jq) ----------
      - name: Build summary (summary.json)
        env:
          UA: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0 Safari/537.36"
        run: |
          set -e

          retry() { # retry <times> <cmd...>
            local n=0; local max=$1; shift
            until "$@"; do n=$((n+1)); [ $n -ge $max ] && return 1; sleep 2; done
          }

          tz=Europe/Madrid
          FECHA=$(TZ=$tz date +'%d/%m/%Y')

          # ----- Ãndices (Stooq, robusto) -----
          pct_stooq () {
            sym="$1"
            csv=$(retry 3 curl -fsSL "https://stooq.com/q/d/l/?s=${sym}&i=d")
            last2=$(printf "%s" "$csv" | tail -n 2 | awk -F, '{print $5}')
            prev=$(printf "%s" "$last2" | head -n1)
            close=$(printf "%s" "$last2" | tail -n1)
            awk -v a="$prev" -v b="$close" 'BEGIN{ if(a>0){printf "%.2f%%", ((b-a)/a)*100}else{print "â€”"} }'
          }
          SP=$(pct_stooq spy.us || echo "â€”")
          NQ=$(pct_stooq qqq.us || echo "â€”")
          DJ=$(pct_stooq dia.us || echo "â€”")

          # ----- Sectores (Finviz Groups) -----
          HTML_G=$(retry 3 curl -fsSL -H "User-Agent: $UA" -H "Referer: https://finviz.com/" "https://finviz.com/groups.ashx?g=sector&v=210" || true)
          SEC_TOP="â€”"; SEC_LOW="â€”"
          if [ -n "$HTML_G" ]; then
            # Obtener pares Sector | Perf Today
            echo "$HTML_G" | pup 'table.table-light tr json{}' \
              | jq -r '
                  .[].children
                  | select(. != null)
                  | [.[1].text, (.[2].text | gsub(",";"."))]
                  | @tsv
                ' \
              | awk -F'\t' 'NF==2 && $1!="" {gsub("%","",$2); printf "%s\t%0.2f\n",$1,$2}' \
              | sort -k2,2nr | head -n3 > /tmp/top.txt || true

            echo "$HTML_G" | pup 'table.table-light tr json{}' \
              | jq -r '
                  .[].children
                  | select(. != null)
                  | [.[1].text, (.[2].text | gsub(",";"."))]
                  | @tsv
                ' \
              | awk -F'\t' 'NF==2 && $1!="" {gsub("%","",$2); printf "%s\t%0.2f\n",$1,$2}' \
              | sort -k2,2n | head -n3 > /tmp/low.txt || true

            [ -s /tmp/top.txt ] && SEC_TOP=$(awk -F'\t' '{printf "%s %.2f%%", $1,$2; if(NR<3) printf ", "}' /tmp/top.txt)
            [ -s /tmp/low.txt ] && SEC_LOW=$(awk -F'\t' '{printf "%s %.2f%%", $1,$2; if(NR<3) printf ", "}' /tmp/low.txt)
          fi

          # ----- S&P500 Movers (Finviz Screener) -----
          Movers () {
            ord="$1" # -change (gainers) / change (losers)
            html=$(retry 3 curl -fsSL -H "User-Agent: $UA" -H "Referer: https://finviz.com/" "https://finviz.com/screener.ashx?v=111&f=idx_sp500&o=${ord}" || true)
            if [ -z "$html" ]; then echo "â€”"; return; fi
            printf "%s" "$html" \
              | pup 'table.table-light tr' \
              | awk -F'[<>]' '
                  /screener-link-primary/ {ticker=$5}
                  /%/ && $0 ~ /<td/ { # capturar ultimo % de la fila
                    gsub(/^[ \t\r\n]+|[ \t\r\n]+$/,"",$0);
                    perc=$0
                  }
                  /<\/tr>/ {
                    if (ticker && perc ~ /%/) { printf "%s %s\n", ticker, perc; c++ }
                    ticker=""; perc="";
                    if (c==3) exit
                  }
                ' | head -n3 | paste -sd', ' - | sed 's/[ ]\+/ /g'
          }
          TOP_G=$(Movers -change)
          [ -z "$TOP_G" ] && TOP_G="â€”"
          TOP_L=$(Movers change)
          [ -z "$TOP_L" ] && TOP_L="â€”"

          # ----- Titular corto (Finviz News) -----
          HEAD=$(retry 3 curl -fsSL -H "User-Agent: $UA" "https://finviz.com/news.ashx" \
            | pup '.news-item-row a:first-of-type text{}, .news-item-row .news-source text{}' \
            | paste - - | head -n1 | awk -F'\t' '{if(NF>=2) printf "%s â€” %s",$1,$2; else print ""}' || true)

          # ----- OpiniÃ³n curada -----
          spv=$(echo "$SP" | tr -d '%' | tr ',' '.') ; [ -z "$spv" ] && spv=0
          nqv=$(echo "$NQ" | tr -d '%' | tr ',' '.') ; [ -z "$nqv" ] && nqv=0
          djv=$(echo "$DJ" | tr -d '%' | tr ',' '.') ; [ -z "$djv" ] && djv=0
          mean=$(awk -v a="$spv" -v b="$nqv" -v c="$djv" 'BEGIN{printf "%.2f", (a+b+c)/3}')

          best1=$(echo "$SEC_TOP" | cut -d',' -f1)
          worst1=$(echo "$SEC_LOW" | cut -d',' -f1)

          OP="SesiÃ³n mixta."
          if awk "BEGIN{exit !($mean<=-0.35)}"; then
            OP="Sesgo <b>risk-off</b>"
          elif awk "BEGIN{exit !($mean>=0.35)}"; then
            OP="Tono <b>risk-on</b>"
          else
            OP="SesiÃ³n mixta"
          fi

          if echo "$best1" | grep -qiE 'Technology|Communication'; then
            OP="$OP: growth lidera"
          elif echo "$worst1" | grep -qiE 'Technology|Communication'; then
            OP="$OP: presiÃ³n en tecnologÃ­a"
          elif echo "$best1" | grep -qiE 'Utilities|Consumer Defensive|Healthcare'; then
            OP="$OP: defensivas al frente"
          fi

          [ -n "$best1" ] && OP="$OP (mejor: ${best1%% *})"
          if [ -n "$worst1" ]; then
            wname="${worst1%% *}"
            OP="$OP Â· peor: $wname"
          fi
          if [ -n "$HEAD" ]; then
            OP="$OP. Noticia: $HEAD"
          fi

          # ----- summary.json -----
          jq -n --arg d "$FECHA" \
                --arg sp "$SP" --arg nq "$NQ" --arg dj "$DJ" \
                --arg secb "$SEC_TOP" --arg secw "$SEC_LOW" \
                --arg win "$TOP_G" --arg los "$TOP_L" \
                --arg head "$HEAD" --arg op "$OP" \
                '{date:$d, sp:$sp, nq:$nq, dj:$dj, secBest:$secb, secWorst:$secw, winners:$win, losers:$los, headline:$head, opinion:$op}' \
            > summary.json

      # ---------- Construir caption (HTML seguro) ----------
      - name: Build caption.txt
        run: |
          DATE=$(jq -r '.date' summary.json)
          SP=$(jq -r '.sp' summary.json)
          NQ=$(jq -r '.nq' summary.json)
          DJ=$(jq -r '.dj' summary.json)
          SEC_BEST=$(jq -r '.secBest' summary.json)
          SEC_WORST=$(jq -r '.secWorst' summary.json)
          WINNERS=$(jq -r '.winners' summary.json)
          LOSERS=$(jq -r '.losers' summary.json)
          OPINION=$(jq -r '.opinion' summary.json)
          HEADLINE=$(jq -r '.headline' summary.json)

          esc() { sed 's/&/&amp;/g; s/</\&lt;/g; s/>/\&gt;/g'; }

          {
            echo "<b>ðŸ“Š Cierre de mercado â€” ${DATE}</b>"
            echo "â€¢ S&amp;P500: ${SP} | Nasdaq: ${NQ} | Dow: ${DJ}"
            echo "â€¢ <b>Sectores destacados:</b> $(printf '%s' "${SEC_BEST}" | esc)"
            echo "â€¢ <b>Peores sectores:</b> $(printf '%s' "${SEC_WORST}" | esc)"
            echo "â€¢ <b>Top ganadores (S&amp;P500):</b> $(printf '%s' "${WINNERS}" | esc)"
            echo "â€¢ <b>Top perdedores (S&amp;P500):</b> $(printf '%s' "${LOSERS}" | esc)"
            echo ""
            echo "ðŸ’¡ <i>OpiniÃ³n:</i> $(printf '%s' "${OPINION}" | esc)"
          } > caption.txt

      # ---------- Enviar a Telegram ----------
      - name: Send to Telegram
        env:
          BOT_TOKEN: ${{ secrets.INVESTX_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          python3 - <<'PY'
          import os, requests
          bot = os.environ['BOT_TOKEN']
          chat = os.environ['CHAT_ID']
          with open("caption.txt","r", encoding="utf-8") as f: caption=f.read()
          with open("heatmap.png","rb") as f:
              r = requests.post(
                  f"https://api.telegram.org/bot{bot}/sendPhoto",
                  data={"chat_id": chat, "caption": caption, "parse_mode":"HTML"},
                  files={"photo": ("heatmap.png", f, "image/png")},
                  timeout=120
              )
              print(r.status_code, r.text)
              r.raise_for_status()
          PY
